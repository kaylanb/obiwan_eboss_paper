% mnras_template.tex
%
% LaTeX template for creating an MNRAS paper
%
% v3.0 released 14 May 2015
% (version numbers match those of mnras.cls)
%
% Copyright (C) Royal Astronomical Society 2015
% Authors:
% Keith T. Smith (Royal Astronomical Society)

% Change log
%
% v3.0 May 2015
%    Renamed to match the new package name
%    Version number matches mnras.cls
%    A few minor tweaks to wording
% v1.0 September 2013
%    Beta testing only - never publicly released
%    First version: a simple (ish) template for creating an MNRAS paper

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Basic setup. Most papers should leave these options alone.
\documentclass[a4paper,fleqn,usenatbib]{mnras}

% MNRAS is set in Times font. If you don't have this installed (most LaTeX
% installations will be fine) or prefer the old Computer Modern fonts, comment
% out the following line
\usepackage{newtxtext,newtxmath}
% Depending on your LaTeX fonts installation, you might get better results with one of these:
%\usepackage{mathptmx}
%\usepackage{txfonts}

% Use vector fonts, so it zooms properly in on-screen viewing software
% Don't change these lines unless you know what you are doing
\usepackage[T1]{fontenc}
\usepackage{ae,aecompl}


%%%%% AUTHORS - PLACE YOUR OWN PACKAGES HERE %%%%%

% Only include extra packages if you really need them. Common packages are:
\usepackage{graphicx}	% Including figure files
\usepackage{amsmath}	% Advanced maths commands
\usepackage{amssymb}	% Extra maths symbols
\usepackage{multicol}        % Multi-column entries in tables
\usepackage{bm}		% Bold maths symbols, including upright Greek
\usepackage{pdflscape}	% Landscape pages
\usepackage{natbib}
%\usepackage{usenatbib}

%%mine
%\usepackage{float}
%\usepackage[demo]{graphicx}

\usepackage[caption = false]{subfig}  %multiple pngs for one figure

\usepackage{trace}
\usepackage{listings}  %upgrade of "verbatim", allows text wrapping
\usepackage{alltt} %non-compiled text tool
\usepackage[normalem]{ulem} %allows underlined text wrap around to next line if too long
%\usepackage{hyperref} % bibtex fields hyperlinks
\usepackage{tablefootnote} %makes \footnote{} work when inside table (places at bottom page)
\usepackage{threeparttable} %need this so where put in table notes actually works

\usepackage{cprotect} % use \verb in figure caption{}

\usepackage[dvipsnames]{xcolor}
\newcommand{\red}[1]{{\textcolor{red}{[#1]}}}
\newcommand{\blue}[1]{{\textcolor{blue}{[#1]}}}
%\newcommand{\red}[1]{{\textcolor{red}{[#1]}}}
\newcommand{\magenta}[1]{{\textcolor{Magenta}{[#1]}}}
\newcommand{\aqua}[1]{{\textcolor{Aquamarine}{[#1]}}}
\newcommand{\green}[1]{{\textcolor{LimeGreen}{[#1]}}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%% AUTHORS - PLACE YOUR OWN COMMANDS HERE %%%%%

\newcommand{\p}{\partial}
\newcommand{\lp}{\left(}
\newcommand{\rp}{\right)}
\newcommand{\lb}{\left[}
\newcommand{\rb}{\right]}
\newcommand{\Lfig}{(\textit{Left})}
\newcommand{\Rfig}{(\textit{Right})}
\newcommand{\Tfig}{(\textit{Top})}
\newcommand{\Bfig}{(\textit{Bottom})}

\newcommand{\Nsrc}{N_{\rm{src}}}
\newcommand{\Nsky}{N_{\rm{sky}}}
\newcommand{\Nout}{N_{\rm{out}}}
\newcommand{\Rout}{R_{\rm{out}}}
\newcommand{\Ndith}{N_{\rm{dith}}}
\newcommand{\Nexp}{N_{\rm{exp}}}
\newcommand{\Nread}{N_{\rm{read}}}
\newcommand{\Fsrc}{F_{\rm{src}}}
\newcommand{\Fsky}{F_{\rm{sky}}}
\newcommand{\msky}{m_{\rm{sky}}}
\newcommand{\msrc}{m_{\rm{src}}}
\newcommand{\Atele}{A_{\rm{tele}}}
\newcommand{\Apix}{A_{\rm{pix}}}
\newcommand{\Neff}{N_{\rm{eff}}}
\newcommand{\Npix}{N_{\rm{pix}}}
\newcommand{\Ps}{P_{\rm{sc}}}
\newcommand{\texp}{t_{\rm{exp}}}
\newcommand{\tmin}{t_{\rm{min}}}
\newcommand{\tmax}{t_{\rm{max}}}
\newcommand{\texpmin}{t_{\rm{exp, min}}}
\newcommand{\texpmax}{t_{\rm{exp, max}}}
\newcommand{\seeing}{\sigma_{\rm{see}}}
\newcommand{\rhalf}{r_{\rm{half}}}
\newcommand{\magsrc}{m_{\rm{src}}}
\newcommand{\zpi}{ZP_i}
\newcommand{\ebv}{E(B-V)}
\newcommand{\toverhead}{t_{\rm{overhead}}}
\newcommand{\tread}{t_{\rm{read}}}
\newcommand{\tslew}{t_{\rm{slew}}}
\newcommand{\thexapod}{t_{\rm{hexapod}}}
\newcommand{\tdeg}{t_{\rm{deg}}}
\newcommand{\tdone}{t_{\rm{done}}}
\newcommand{\tperfect}{t_{\rm{perfect}}}
\newcommand{\tneed}{t_{\rm{need}}}
\newcommand{\tneedi}{t_{\rm{need, i}}}
\newcommand{\texpi}{t_{\rm{exp, i}}}
\newcommand{\tneedj}{t_{\rm{need, j}}}
\newcommand{\Nslow}{N_{\rm{eff \, < \,3}}}
\newcommand{\Nall}{N_{\rm{all}}}
\newcommand{\Npts}{N_{\rm{pts}}}

\newcommand{\texpo}{t_{\rm{exp, 0}}}
\newcommand{\Fsrco}{F_{\rm{src, 0}}}
\newcommand{\Fskyo}{F_{\rm{sky, 0}}}
\newcommand{\Apixo}{A_{\rm{pix, 0}}}
\newcommand{\Neffo}{N_{\rm{eff, 0}}}
\newcommand{\Kco}{K_{\rm{co}}}
\newcommand{\Aco}{A_{\rm{co}}}
\newcommand{\zpo}{ZP_0}
\newcommand{\zpt}{ZP}
\newcommand{\mskyo}{m_{\rm{sky, 0}}}
\newcommand{\msrco}{m_{\rm{src, 0}}}
\newcommand{\mdesione}{m_{\rm{desi, 1}}}
\newcommand{\mdesitwo}{m_{\rm{desi, 2}}}

\newcommand{\gdecam}{g_{\rm{decam}}}
\newcommand{\rdecam}{r_{\rm{decam}}}
\newcommand{\zdecam}{z_{\rm{decam}}}
\newcommand{\zmosaic}{z_{\rm{mosaic}}}
\newcommand{\gps}{g_{\rm{ps1}}}
\newcommand{\rps}{r_{\rm{ps1}}}
\newcommand{\zps}{z_{\rm{ps1}}}
\newcommand{\gi}{\gps - \rps}
\newcommand{\maperture}{m_{\rm{ap}}}

\newcommand{\ith}{i^{\rm{th}}}
\newcommand{\jth}{j^{\rm{th}}}

\newcommand{\seff}{\text{Survey}_{\rm{ineff}}}
\newcommand{\totalobs}{T_{\rm{obs}}}
\newcommand{\totalreobs}{T_{\rm{reobs}}}
\newcommand{\totalneed}{T_{\rm{need}}}

\newcommand{\logten}{\log_{\rm{10}}}
\newcommand{\Ne}{N_{\rm{e-}}}
\newcommand{\Nskye}{N_{\rm{sky, \, e-}}}
\newcommand{\imageskysub}{\text{Image} - \text{Sky}_{\rm{interp}}}
\newcommand{\mAB}{m_{\rm{AB}}}
\newcommand{\mskyAB}{m_{\rm{sky, AB}}}
\newcommand{\PSmag}{m_{\rm{PS1}}}
\newcommand{\RAgaia}{RA_{\rm{gaia}}}
\newcommand{\DECgaia}{DEC_{\rm{gaia}}}
\newcommand{\RAgood}{RA_{\rm{good}}}
\newcommand{\DECgood}{DEC_{\rm{good}}}
\newcommand{\radiff}{\Delta \text{Ra}}
\newcommand{\decdiff}{\Delta \text{Dec}}
\newcommand{\decrms}{\sigma_{\Delta \text{Dec}}}
\newcommand{\rarms}{\sigma_{\Delta \text{Ra}}}

\newcommand{\skycounts}{\text{Sky}_{e-}}
\newcommand{\skymag}{m_{\rm{sky}}}
\newcommand{\sigmasky}{\sigma_{\rm{sky}}}
\newcommand{\sigmaskyeff}{\sigma_{\rm{sky, eff}}}
\newcommand{\reltransp}{\text{transp}_{\rm{rel}}}
\newcommand{\phoff}{\text{phoff}}
\newcommand{\arcsectwo}{\text{arcsec}^2}
\newcommand{\Xo}{X_0}
\newcommand{\fwhmCP}{\text{FWHM}_{\rm{CP}}}
\newcommand{\fwhmMoffat}{\text{FWHM}_{\rm{Moffat}}}
\newcommand{\fwhmo}{\text{FWHM}_0}
\newcommand{\mdepth}{m_{\rm{depth}}}

\newcommand{\gb}{$g$}
\newcommand{\rband}{$r$}
\newcommand{\zb}{$z$}
\newcommand{\grcolor}{$g - r$}
\newcommand{\rzcolor}{$r - z$}

\newcommand{\tractor}{{\tt Tractor}}
\newcommand{\legacypipe}{{\tt Legacypipe}}
\newcommand{\obiwan}{{\tt Obiwan}}
\newcommand{\balrog}{{\tt BALROG}}
\newcommand{\sextractor}{{\tt Source Extractor}~}
\newcommand{\psfex}{{\tt PSFex}}
\newcommand{\sersic}{Sersic}
\newcommand{\dev}{de Vaucouleurs}
\newcommand{\healpix}{{\tt HEALPIX}}


% Please keep new commands to a minimum, and use \newcommand not \def to avoid
% overwriting existing commands. Example:
%\newcommand{\pcm}{\,cm$^{-2}$}	% per cm-squared

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%% TITLE PAGE %%%%%%%%%%%%%%%%%%%

% Title of the paper, and the short title which is used in the headers.
% Keep the title short and informative.
\title[Removing Imaging Systematics with \obiwan]{Removing Imaging Systematics from the eBOSS ELG Sample with \obiwan}

% The list of authors, and the short list which is used in the headers.
% If you need two or more lines of authors, add an extra line using \newauthor

\author[K. J. Burleigh]{
Kaylan J. Burleigh,$^{1,2}$ \thanks{E-mail: kaylanb@berkeley.edu (KJB)}
Hui Kong,$^{5}$
Johan Comparat,$^{3,4}$
John Moustakas,$^{6}$ 
\newauthor
Anand Raichoor,$^{7,8}$
Ashley Ross$^{5}$
\& David Schlegel$^{2}$
%Peter E. Nugent$^{1,2}$
%\newauthor
%Anna Patej, John Moustakas,$^{5}$, David J. Schlegel$^{2}$, Eddie F. Schlafly$^{2}$, 
%\newauthor and the Legacy Survey Teams
\\
%% List of institutions
$^{1}$Department of Astronomy, University of California at Berkeley, 501 Campbell Hall \#3411, Berkeley, CA 94720, USA\\
$^{2}$Lawrence Berkeley National Laboratory, One Cyclotron Road, Berkeley, CA 94720, USA\\
$^{3}$Departamento de Fisica Teorica, Universidad Autonoma de Madrid, Cantoblanco E-28049, Madrid, Spain \\
$^{4}$Instituto de F\'{i}sica Te\'{o}rica, (UAM/CSIC), Universidad Aut\'{o}noma de Madrid, Cantoblanco, E-28049 Madrid, Spain \\
$^{5}$Department of Physics, Ohio State University, 191 West Woodruff Avenue, Columbus, Ohio 43210, USA \\ 
$^{6}$Department of Physics \& Astronomy, Siena College, 515 Loudon Road, Loudonville, NY, USA 12211 \\
$^{7}$Institute of Physics, Laboratory of Astrophysics, Ecole Polytechnique F\'{e}d\'{e}rale de Lausanne (EPFL), Observatoire de Sauverny, CH-1290 Versoix, Switzerland \\
$^{8}$CEA, Centre de Saclay, IRFU/SPP, F-91191 Gif-sur-Yvette, France \\
}
%$^{4}$Department of Astronomy \& Astrophysics and Dunlap Institute, University of Toronto, Toronto, ON, M5S 3H4, Canada \\
%$^{5}$Department of Physics and Astronomy, Siena College, Loudonville, NY 12211, USA
%}


% These dates will be filled out by the publisher
\date{Accepted YYY. Received YYYY; in original form YYYY}

% Enter the current year, for the copyright statements etc.
\pubyear{2018}

% Don't change these lines
\begin{document}
\label{firstpage}
\pagerange{\pageref{firstpage}--\pageref{lastpage}}
\maketitle

% Abstract of the paper
\begin{abstract}
Images of the night sky are transformed into a 3-dimensional large--scale--structure catalog by passing them through a pipeline that automatically detects and models galaxies and then obtaining spectra and measuring redshifts for a sample of the galaxies. Clustering statistics computed from large--scale--structure catalogs, such as the two point correlation function, provide a measure of the expansion rate of the universe and can answer many fundamental questions about the universe. Systematics from the imaging data must be removed to compute these clustering statistics; however, the current methods for removing the systematics (e.g. map--based methods) are ill suited for the next generation of galaxy surveys, such as the Legacy Surveys. We propose a new method for removing imaging systematics that does not require maps of imaging systematics or foregrounds. We apply to this method to the eBOSS ELG sample using the \obiwan\, code, which is described in a companion paper \cite{obiwanMethods}. We derive an angular correlation function that both reproduces previous ELG correlation functions \citep{corrfuncEboss} and extend the correlation function to larger $\theta$. This analysis is a preparatory step for analyzing imaging and spectroscopic data for the Dark Energy Spectroscopic Instrument (DESI).
\end{abstract}

% Select between one and six entries from the list of approved keywords.
% Don't make up new ones.
\begin{keywords}
methods: observational
\end{keywords}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%% BODY OF PAPER %%%%%%%%%%%%%%%%%%

\section{Introduction}

Astronomers perform galaxy surveys to measure how galaxies cluster at different times in the past. Clustering statistics, such as the three dimensional correlation function projected onto a sphere (the angular correlation function), provide a measure of the expansion rate of the universe and can answer many other fundamental questions about the universe \citep{peebles1980}. Some of the most widely known galaxy--redshift surveys include the APM \citep{apmSurvey}, CfA \citep{cfaOne, cfaTwo}, SDSS \citep{sdssYork}, 2dFGRS \citep{2dFGRS}, WiggleZ \citep{wigglezSurvey}, BOSS \citep{bossSurvey}, and eBOSS \citep{dawson15}. Images of the night sky are transformed into a 2--dimensional large--scale--structure catalog by passing them through a pipeline that automatically detects and models galaxies and stars in the calibrated images. This becomes a 3--dimensional catalog by selecting galaxies that satisfy particular selection criteria and obtaining spectra and measuring redshifts for them. Clustering statistics are then computed from the positions of the galaxies on the sky and their redshifts. 

Removing biases and systematics due to the imaging data (imaging systematics) is critical for measuring unbiased clustering statistics like the angular correlation function. Map--based methods, such as template subtraction and mode projection \citep{biasInTemplateMethod}, have successfully removed imaging systematics from the SDSS, WiggleZ, BOSS, and eBOSS surveys; however, it is unlikely that these methods, in their current state, will be able to handle the complexities of future and ongoing galaxy surveys, such as the Legacy Surveys. Map--based methods use a pixelization scheme, such as \healpix\, \citep{healpix}, to subdivide the sky into equal--area pixels and then compute various per--pixel quantities: the number of galaxies in the large--scale--structure catalog (data), the average seeing, sky brightness, exposure time, etc. (imaging meta--data) and galactic extinction (foregrounds). The non--data maps are potential imaging systematics and are turned into pixel weight maps (in configuration space) or mode weights (in Fourier space). The weights mimic how the angular selection function samples the true distribution of galaxies yielding the observed large--scale--structure catalog \citep{biasInTemplateMethod}.
% the weights can be chained together by multiplying the weights for all systematics or can be fit to all systematics simultaneously

The two most popular map-based methods are ``template subtraction" \citep{sdss1Systematics, myers06, sdss8Systematics, sdss8Companion, sdss9Systematics, sdss12Systematics, wigglezSelectionFunc, delubacSystematics, qsoDepthExtinction, prakashRegressionTech, myersRegressionTech, elvinpoole} and ``model projection" \citep{rybicki92, tegmark98, uros04, biasInTemplateMethod, leistedt13}. Template subtraction is a model for how the number of galaxies depends on each systematic. In pixel space, the data is divided by the model; in Fourier space, the model is subtracted from the data. To avoid modeling chance correlations, only the systematic maps with the largest data cross correlation are modeled. Mode projection treats the systematic maps as adding noise to each mode in Fourier space or pixels in configuration space, so that values in the data covariance matrix are increased for modes where each systematic map is large. It robustly models the impact of the linear combination of the systematics, but does not include non-linear effects from the systematics. 
% biasInTemplateMethod for why template subtraction method overfits
% leistedt13 is best overview for the mode projection method
% they both do "mode projection" because the pixelized maps are a summation of basis functions (usually spherical harmonics) in Fourier space. The observed datas is the superpostion of cosmological signal modes and systematics modes. Computing a correlation function or power spectrum in Fourier space ``projects" the data onto the basis function's modes. The template subtraction method builds a model for each systematic and subtracts the model in Fourier space (or divides by it in configuration space), while the mode projection method increases the covariance matrix of the data at modes where each systematic is strongest.

These map--based methods are ill suited for the next generation of galaxy surveys, such as the Legacy Surveys \citep{overviewPaper}. For example, a substantial fraction (2--10\%) of the data is removed because the number of observed galaxies deviates significantly from the mean due to regions near bright stars, observations at high airmass or particularly bad seeing. There are many systematics to test for, only the systematics known apriori can be modeled, and it is unclear how to make  systematics maps for regions of the sky with varying amounts of repeat imaging. For example, \cite{elvinpoole} 
%threw out about 20\% of the imaging data and 
created 21 systematic maps to model systematics in their DECam imaging data. Such methods also ignore biases or systematics introduced by the pipeline that created the large--scale--structure catalog. Large--scale--structure catalogs from the Legacy Surveys require a joint analysis of images from three telescopes. Each telescope will obtain multi-- and same--band images of the same part of the sky that are separated by month to year time baselines. The CCD detectors also have similar angular size (0.5 to 2 deg) to the BAO signal signal ($\sim 5$ deg at redshift of 1).
%It is unclear whether map-based methods are capable of removing imaging systematics, especially due to the latter, at a level sufficient for a Stage-IV dark energy science. 
%The complexities of the Legacy Surveys have already revealed shortcomings in the current method for removing imaging systematics. 

We present a new method for removing imaging systematics at the individual exposure level from future and ongoing surveys that does not require maps of imaging systematics, foregrounds, or other apriori knowledge (i.e. it is non--parametric), and that corrects for biases and systematics in the software pipeline that produced the large--scale--structure catalog. We apply our method to DECam data from the Legacy Surveys using the \obiwan\, code \citep{obiwanMethods}. We inject realistic emission line galaxies (ELGs) into the DECam images used to create for DR3--era \tractor\, catalogs, which the eBOSS Team used to select ELG targets \citep{anand17}. We use \obiwan\, to perform Monte Carlo simulations of how the \legacypipe/\tractor\, pipeline \citep{tractorPaper} detects and forward--models eBOSS ELG--like galaxies. \obiwan\, is very similar to the \balrog\, \citep{balrog}, which injects sources into coadded DECam images and builds a large--scale--structure catalog using \sextractor; however, \obiwan\, is unique in that it operates on individual exposures and (by virtue of \legacypipe\, and \tractor) maximizes the likelihood of the data to find the best model parameters for its sources. Benefits of using individual exposures and maximum likelihood (not heuristic) techniques are discussed in \cite{obiwanMethods}.

Our goal is compute the angular correlation function for eBOSS ELGs, with and without \obiwan, to estimate the impact of this method on eBOSS science requirements. This is also a preparatory step towards future analysis of the Dark Energy Spectroscopic Instrument (DESI) ELG sample, because DESI will select targets using Legacy Surveys data and its five--year survey is significantly more complicated than eBOSS \citep{desiScience, desiInstrument}.  All data products are available at NERSC (see Section \ref{eboss:data-products}).
%will obtain spectra for about 30M galaxies and all targets will come from the Legacy Surveys 
%We can measure the impact of \obiwan\, on the primary science objectives of surveys like eBOSS and DESI, by computing two-point correlations functions with and without our corrections applied. 

%The model for each systematic predicts how much to up- or down-sample the number of galaxies in a given part of the sky. This method assumes apriori knowledge of the potential imaging systematics and that they are independent of one other. 
%These assumptions will likely break down in the next generation of galaxy surveys, such as the Legacy Surveys (aka DECaLS, MzLS, and BASS) \imtxt{CITE OVERVIEW PAPER}. 
%The Legacy Surveys take images with three telescopes and leverage existing imaging from Wide-field Infrared Survey Explorer (WISE) \imtxt{cite} to detect galaxies. 

% Johan suggests a graph that explains the following
% simulated eBOSS ELG \righarrow (legacy survey pipeline + legacy survey data) \rightarrow systematic free obiwan random sample.
% observed eBOSS ELG large--scale--structure catalog x obiwan random \rightarrow w theta with lowest level of systematics compared to the usual way to generate randoms.
% KS-test between:  data x all random sets will validate that obiwan is closer to the parent distribution of the data.

This paper is structured as follows. In \S\,\ref{sec:data}, we describe the imaging and spectroscopic data we use and the eBOSS ELG target selection criteria. In \S\,\ref{sec:methods}, we summarize how \obiwan\, and \tractor\, work, the algorithms we use for removing imaging systematics, and the angular correlation function is estimated from a large--scale--structure catalog. In \S\,\ref{sec:results}, we present our \obiwan\, Monte Carlo simulations of the imaging data used to select eBOSS ELGs, and the resulting angular correlation functions. We conclude in \S\,\ref{sec:conclusions}. The Appendix presents biases and systematics in the Legacy Surveys image reduction pipeline, and the additional information needed to reproduce our \obiwan\, Monte Carlo simulations.

\section{Data}
\label{sec:data}

\subsection{The DECam Legacy Survey (DECaLS)}

The DECaLS is a \gb, \rband, \zb-band survey of 9,000 deg$^2$ of the southern sky using the Blanco 4-m telescope and DECam camera\footnote{\url{http://www.ctio.noao.edu/noao/content/DECam-Observing-Manual}} in Cerro Tololo, Chile. DECam has a field of view of 3.18 deg$^2$ and is a mosaic of 62 CCDs, each having 4096x2046 pixels, with pixel scale of 0.262\arcsec\, pixel$^{-1}$. The DECaLS depth requirements are 1--2 mag deeper than the SDSS. For more details see \cite{overviewPaper, strategyPaper}.

The first round of eBOSS ELG target selection \citep{anand17} used a combination of DR3\footnote{\url{http://legacysurvey.org/dr3}} \tractor\, catalogs and a set of reprocessed DR3 \tractor\, catalogs (produced by the eBOSS team) that included DECam images observed after the DR3 March 2016 cutoff.  We will refer to these as the DR3--plus catalogs. The list of DECam CCDs used to create the DR3--plus catalogs is available online\footnote{\url{http://portal.nersc.gov/project/desi/users/kburleigh/obiwan/legacysurveydir_ebossdr3}}. Fig. \ref{fig:ccds-eboss} shows these CCDs and the approximate eBOSS NGC and SGC regions (blue boxes). 

\begin{figure}
     \subfloat[NGC\label{fig:ccds-ngc}]{%
       \includegraphics[width=\columnwidth]{figs/ccdsused_eboss_ngc}
     }
     \hfill
     \subfloat[SGC\label{fig:ccds-sgc}]{%
       \includegraphics[width=\columnwidth]{figs/ccdsused_eboss_sgc}
     }
\caption{The eBOSS NGC and SGC footprints (blue boxes) and the DECaLS CCDs used to create the DR3--plus \tractor\, catalogs.}
\label{fig:ccds-eboss}
\end{figure}

\subsection{eBOSS ELG Target Selection}
\label{sec:eboss-ts}

eBOSS selected ELGs from DR3--plus \tractor\, catalogs having clean DECaLS photometry, locations outside bright star masks, sufficient \gb--flux to be [O II] emitters and star forming galaxies, and \grcolor\, and \rzcolor\, color associated with galaxies in the desired redshift range of 0.5 -- 2. The eBOSS ELG footprint is split into the two regions (blue boxes) shown in Fig. \ref{fig:ccds-eboss}. The regions include 620 deg$^2$ in the South Galactic Cap (SGC) and 600 deg$^2$ in the North Galactic Cap (NGC). ELGs in the SGC are selected using by the following \tractor\, catalog cuts,

\begin{itemize}
\item \verb|brick_primary = True|
\item \verb|decam_anymask[grz] = 0|
\item $21.825 < g < 22.825$
\item $-0.068\, (r-z) + 0.457 < g-r < 0.112\, (r-z) + 0.773$
\item $0.218\, (g-r) + 0.571 < r-z < -0.555\, (g-r) + 1.901$
\end{itemize}

\noindent The NGC cuts are identical except for,

\begin{itemize}
\item $21.825 < g < 22.9$
\item $0.637\, (g-r) + 0.399 < r-z$
\end{itemize}

\noindent Bright star masks are also applied. For more details see \cite{anand17}.

It was later discovered that \verb|decam_anymask[grz] = 0| is magnitude dependent and removes many good ELG candidates. \verb|decam_allmask[grz] = 0| should have been used instead. Identifying and removing the biases and systematics introduced \verb|decam_anymask[grz] = 0| has proven difficult; fortunately, our \obiwan\, Monte-Carlo simulations will resolve this problem because they provide a set of randoms with and without the \verb|decam_anymask[grz] = 0| cut applied. 

\subsection{Joint Tables of eBOSS Spectra and \tractor\, Catalogue Measurements}
\label{sec:eboss-tractor}

To build a representative sample of eBOSS ELG galaxies (see \S\, \ref{sec:injecting-elgs}), we use the following joint tables of eBOSS 21, 22, 23 spectra and associated DR3--plus \tractor\, catalog measurements,

\begin{itemize}
\item \verb|eBOSS.ELG.obiwan.eboss21.v5_10_4.fits|
\item \verb|eBOSS.ELG.obiwan.eboss2122.v5_10_7.fits| 
\item \verb|eBOSS.ELG.obiwan.eboss22.v5_10_4.fits|
\item \verb|eBOSS.ELG.obiwan.eboss23.v5_10_4.fits|
\item \verb|eBOSS.ELG.obiwan.eboss23.v5_10_7.fits|
\end{itemize}

\noindent We cut to spectroscopically confirmed galaxies (\verb|z_flag| $= 1$), and drop NGC sources (about 30\% of the sample) because the NGC \tractor\, catalogs are incomplete at \gb\, $\sim 23.8$ mag (see Fig. \ref{fig:ngc-incomplete}).
%0.025 - 0.1 mag brighter than the \gb\, limit for eBOSS ELGs. 
We will refer to these as the eBOSS--\tractor\, tables. 

\subsection{The DEEP2 Galaxy Redshift Survey (DEEP2)}

DEEP2 obtained about 50,000 high resolution (R $\sim 6000$) spectra of redshift $\sim 1$ galaxies using the DEIMOS multi--object on Keck 2 \citep{deep2}. The DEEP2 footprint is 2.8 deg$^2$, split into four disjoint regions: Field 1 (14hr), Field 2 (16h), Field 3 (23h), and Field 4 (02h). We create a DEEP2 (DR4) and DECaLS DR3 matched table by finding the nearest DR3 \tractor\, catalog source within a 1\arcsec\, search radius of each DEEP2 spectrum. The DECaLS DR3 footprint does not overlap Field 1, so our table only includes Fields 2--4. We refer to it as the DR3--DEEP2 table and use it in \S\, \ref{sec:injecting-elgs}.

\subsection{Mock Catalogs of ELG Clustering}
\label{sec:elg-mocks}

Most ELG galaxy samples are incomplete in stellar mass and/or emission line flux, so their clustering properties are hard to model using simulations \citep{johan13}. However, \cite{corrfuncEboss} showed that this incomplete sampling of ELGs can be modeled by combining existing photometric and spectroscopic data with the latest MultiDark $N$--body simulations \citep{multiDark} and by changing how the (Sub)Halo--Abundance Matching method \citep{shamOne, shamTwo} assigns galaxies to (simulated) dark matter halos. They conclude that their mock catalogs, which we will refer to as the ELG mock catalogs, have the correct angular and redshift--space clustering for ELGs having redshifts of $0.6 < z < 1$. In Section \ref{sec:results-cf}, we compare the angular correlation function of the ELG mock catalog
%\footnote{\url{http://projects.ift.uam-csic.es/skies-universes/MultiDark/ELG_mock/data/}} 
to our \obiwan\, measurements for eBOSS ELGs.

%Previous studies have measured the angular correlation function for eBOSS-like ELGs for $\theta < 1\,$ deg. \cite{corrfuncEboss} computed the angular correlation function for an ELG galaxy sample selected using $\sim 44$ deg$^2$ of $ugri$-photometry from the Canada-France-Hawaii Telescope Legacy Survey (CFHT-LS) and (1\arcsec\, matched) spectroscopy from BOSS DR12 and DEEP2. Their sample is located in the W3 field, has 500 ELGs per deg$^2$, a redshift range of $0.6 < z < 1$. We will refer to this as the CFHT-BOSS-DEEP2 angular correlation function, and compare it our angular correlation functions from \obiwan\, in Section \ref{eboss:results-cf}. 

\section{Methods}
\label{sec:methods}

\subsection{\obiwan}
\label{sec:methods-obiwan}

We add simulated sources, with properties closely matched to the galaxies of interest, to random locations in the imaging data and then run the relevant source detection and measurement software. By measuring how the simulated sources are lost and recovered we can completely describe the angular selection function of the galaxy survey. This enables us to downsample an initially random distribution of galaxies, based on the selection function, and to compare resulting distribution to the observed galaxy sample. We call our method \obiwan, since it may be the only hope of accounting for the aforementioned imaging systematics. 

\obiwan\, modifies the \gb, \rband, \zb\, images that \legacypipe\, operates on by adding simulated sources to the individual exposures and appropriately modifying the inverse variance images. The simulated sources include poisson noise from the source itself. The power of \obiwan\, is that the injected sources inherit the sky background, systematics, or whatever else is present in the data, so nothing more than the simulated galaxy or star of interest is injected. \legacypipe\, does not know the images have been modified and source detection, model fitting, and model selection proceed as usual. For more details see \cite{obiwanMethods}.

Fig. \ref{fig:examples-bright} compares real and simulated galaxies that have exponential profiles and relatively bright \gb--band magnitudes. These are eight galaxies, out of 130k eBOSS 21, 22, 23 ELG SGC targets and 1.2M injected ELGs, that are relatively bright in \gb--band. Their color and high S/N are not representative of the full distribution; however, based on Fig. \ref{fig:examples-bright} and visual inspection of many more galaxies that span the full distribution, we cannot tell the difference between the real and simulated ELGs. 
%i.e. they are representative of real ELGs.

\begin{figure}
 %\includegraphics[width=\columnwidth]{figs/fake_real_mosaic_istart_0}
 \includegraphics[width=\columnwidth]{figs/fake_real_mosaic}
 \caption{Comparison between real and simulated galaxies having exponential profiles and relatively brighter \gb--band magnitudes. The label for each image is on the left and its corresponding \gb\, magnitude is the number on the right. Each row is a single galaxy. The first column is a three color jpeg for easy visualization. The remaining columns are the per--band full resolution coadds for the \gb, \rband, \zb\ images and associated inverse variance maps. Consecutive rows of R and F (rows 1 and 2, 3 and 4, etc.) have similar \gb\, magnitude for a fair comparison.}
 \label{fig:examples-bright}
\end{figure} 

\obiwan\, performs a Monte Carlo Simulation by injecting the simulated galaxies at random RA and Dec, running \legacypipe, and repeating for the same images. Blending can occur between pairs of real--real, real--simulated, and simulated--simulated sources. Our goal is to simulate effects involving galaxies, so we prevent blending between simulated--simulated sources. We temporarily setting aside all simulated sources that would be within 5\arcsec\, of another simulated source, and injected those set--aside sources during the next Monte Carlo iteration. Blending between real and simulated sources is allowed (and needed to fully simulate the angular selection function). This 5\arcsec\, criterion only applies to pairs of simulated sources. The initially random galaxy positions are modified by the geometry of the footprint, source detection, measurement, target selection, and any biases and systematics in the \legacypipe\, pipeline. We will refer to these as \obiwan--randoms, and the truly random galaxy positions (e.g. the RA, Dec for all the sources we tried to inject into the imaging data) as uniform--randoms.
%Unlike the methods that rely on backward-modeling of apriori imaging systematics, these {\it{obiwan randoms}} have already modified by the full covariance between {\it{all}} imaging systematics, those we expected apriori but also those not expected or unknown. The obiwan randoms are also modified which are of course in the real galaxy sample as well. 

\subsection{Injecting Realistic ELGs}
\label{sec:injecting-elgs}

This section summarizes how we generate the representative sample of eBOSS ELG-like galaxies that we inject into the images. A representative sample is crucial to the success of our method because we can only use the randoms if they truly mimic the properties of the real galaxies we are interested in. 

We use the eBOSS--\tractor\, tables to build a sample of eBOSS ELG targets having a redshift, shape, and \gb, \rband, \zb flux. DEV galaxies are systematically larger and about 1 mag brighter than EXP in all bands (see Fig. \ref{fig:dev-brighter}), so we split the sample into separate DEV and EXP samples. The final ``eBOSS sample'' has 77,525 EXP and 7,439 DEV galaxies. See Section \ref{sec:input-sample} for more details.

To simulate contamination we need to inject ELGs that are just outside the eBOSS ELG color box and \gb--mag boundaries. We find that DEEP2 is a complete galaxy survey in the sense that it contains the eBOSS ELG selection. The DR3--DEEP2 galaxies reproduces the brightness, shape, and redshift distributions of the eBOSS sample (see Section \ref{eboss:eboss-almost-targets}), so we use it to construct a sample of ELGs that are within 0.2 mag of the eBOSS ELG color box and \gb--mag boundaries. The final ``DR3--DEEP2'' sample has 1,064 EXP and 85 DEV galaxies. See Section \ref{eboss:eboss-almost-targets} for more details.

We now describe our algorithm to jointly sample an eBOSS n(z) redshift and its associated brightness, shape, and size using our eBOSS and DR3--DEEP2 samples. The eBOSS n(z) is the redshift distribution of spectroscopic redshifts from the eBOSS--\tractor\, tables weighted by spectroscopic completeness (1/TSR). To sample from n(z), we intentionally over--fit a 10 component Gaussian Mixture Model (GMM).

We draw redshifts from n(z), dropping those outside the allowed redshift range [0,2], until there are N redshift samples. For each redshift, we find its nearest redshift in our (EXP--DEV combined) DR3--DEEP2 sample. By finding the nearest redshift we hope to preserve the redshift dependence on galaxy brightness, shape, and size. We decide whether each galaxy should have an exponential or \dev\, profile using the following chance model. We define an ELG as passing eBOSS ELG SGC target selection. If the redshift--brightness--shape sample is an ELG, we find its nearest redshift in the EXP eBOSS sample (90\% of the time) or the DEV eBOSS sample (10\% of the time); if not, we trim the DR3--DEEP2 sample to galaxies that extends beyond the eBOSS ELG selection boundaries, and find its nearest redshift in the trimmed EXP DR3--DEEP2 sample (90\% of the time) or the trimmed DEV DR3--DEEP2 sample (10\% of the time). This yields a sample of eBOSS ELG--like galaxies with the desired redshift distribution. See Section \ref{sec:final-eboss-sample}.

\subsection{Run \obiwan\, on the DECam CCDs used to Select ELG Targets for eBOSS}

We use \obiwan\, to inject simulated galaxies into the DECam CCDs used to create the DR3-plus \tractor\, catalogs. We use the current version of \legacypipe\, and not the two year-old version that actually created the DR3-era \tractor catalogs. We do not expect this to bias our results because we find excellent agreement between DR3 and DR5 measurements for the same sources. We configure \obiwan\, to run \legacypipe\, with the \verb|--simp| option, which uses the SIMP model instead of REX, and to explicitly use all the input CCDs (used to create the DR3-era \tractor\, catalogs and to select the eBOSS ELG targets).   

\subsection{The Angular Correlation Function}
\label{sec:methods-cf}

The correlation function is a statistic that measures the clustering of galaxies, relative to a random distribution on the unit sphere, for a range of galaxy--galaxy separations \citep{peebles1980, corrfuncHamilton, weinberg, corrfuncErrors, corrfuncIC, corrfuncEboss}. The two point correlation function (2PCF), $\xi(r)$, uses the 3D positions (RA, Dec, and redshift) of the galaxies, while the angular correlation function (ACF), $w(\theta)$, uses the 2D positions (RA and Dec). For $\xi(r)$, one must adopt a cosmological model to convert RA, Dec, and redshift to comoving coordinates. A power law is often assumed for $\xi(r)$,
\begin{align}
\xi (r) \propto \lp\frac{r}{r_0}\rp^{-\gamma}, 
\end{align}
where $r_0$ is the characteristic separation between galaxies. For small angles ($\theta \ll 1 \text{rad} \approx 60 \, \text{deg}$) the angular correlation function is also a power law \citep{limberApprox}, 
\begin{align}
w(\theta) \propto \theta^{1-\gamma}, \label{eqn:limber}
\end{align}
if redshift distribution of the galaxy sample varies more slowly than the other functions of redshift that are integrated over to go from $\xi(r)$ to $w(\theta)$. Eqn. (\ref{eqn:limber}) is known as the Limber approximation. For ELGs, $\gamma \sim 1.6-1.8$ and $r_0 \sim 4$ Mpc h$^{-1}$ \citep{weinberg, corrfuncEboss}.
%1.7-1.8 for galaxies (conolloy 2002)
%ELG gamma=1.6, r0=4 (Ellie)
%LRG gamma= 1.8, r0=10 (Ellie)
%QSOs gamm= 1.6, r0=6 (Ellie)
We will use the ACF to gauge the scientific impact of \obiwan\, on eBOSS science.
%distance to each galaxy from Earth (e.g. measured from a spectrum).

The joint probability of finding two galaxies in solid angle $d\Omega_1$ and $d\Omega_2$ separated by angle $\theta$ is given by \citep{peebles1980, corrfuncIC}
\begin{align}
dP(\theta)= n^2 [1+w(\theta) ] d\Omega_1 d\Omega_2,
\end{align}
\noindent where n is the surface density of galaxies. The ACF is how much more (or less) likely we are to find a galaxy than we would if they were randomly distributed on the unit sphere. The minimum variance estimator for the ACF is \citep{landy93},  
\begin{align}
w(\theta) &= 1 + \frac{N_R (N_R - 1)}{N_D (N_D - 1)} \frac{DD}{RR} - 2\lp \frac{N_R-1}{N_D} \rp \frac{DR}{RR} \nonumber \\
&\approx 1 + \lp \frac{N_R}{N_D} \rp^2 \frac{DD}{RR} - 2\lp \frac{N_R }{N_D} \rp \frac{DR}{RR} 
\label{eqn:landy93}.
\end{align}
where $DD$ is the number of real galaxy--real galaxy pairs with separation between $\theta$ and $\theta + \Delta \theta$, $RR$ is the number of random--random pairs, and $N_D$ and $N_R$ are the total number of real galaxies and randoms in the data set, respectively. Computing the correlation function reduces to pair--counting three samples of points for different pair separations ($\theta$).
%which is also an unbiased estimator for the two--point correlation function \citep{corrfuncIC}.  
%The randoms are a sample of random locations on a unit sphere that are then modified by the same procedure u99sed to select the galaxy sample.  

We will compute the ACF using Jackknife sampling. For each bin in $\theta$, we estimate the average of the ACF, $\overline{w(\theta)}$, over the full survey footprint. To estimate the variance of our $\overline{w(\theta)}$ measurement, i.e. the square of the standard error, we divide the footprint into N$_{sub}$ equal area regions. This yields N$_{sub}$ different subsamples each with area $(N_{sub} - 1) / N$ times that of the footprint. We compute the ACF in each subsample and the variance of our N$_{sub}$ $w(\theta)$ measurements is $\sigma_{\rm{w(\theta), Jack}}^2$,
\begin{align}
\sigma_{\rm{w(\theta), Jack}}^2 = \frac{N-1}{N}\sum_i^N (w_i(\theta) - \overline{w(\theta)})^2,
\end{align}
\noindent This is equivalent to k--fold cross validation using $k=N_{sub}$ and spatially chosen subsamples, instead of random. Too many subsamples (i.e. subsamples with too small an area) results in dependent subsamples and limits the maximum $\theta$ that $w(\theta)$ can be measured for; too few subsamples leads to a large variance on $w(\theta)$. For a Gaussian distribution, the standard error on an estimate of the standard deviation ($\sigma$) is $\text{std. error} \approx \sigma/\sqrt{2(N-1)}$ \citep{stderrVar}. For $N_{sub}=50$, the relative standard error on $\sigma_{\rm{w(\theta), Jack}}$ is 10\% \citep{corrfuncErrors}.

Chance fluctuations (aka Poisson noise, shot noise, or cosmic variance) in $DD(\theta)$ and $RR(\theta)$ also contribute to $\sigma_{\rm{w(\theta)}}$,
\begin{align}
\sigma_{\rm{w(\theta), Chance}}^2 = \frac{1}{DD(\theta)}[1+w(\theta) ]^2. \label{eqn:sigma-chance}
\end{align}
\noindent There is no $RR(\theta)$ term as long as substantially more randoms than real galaxies are used when computing the correlation function \citep{corrfuncIC}.


\section{Results}
\label{sec:results}

\subsection{Run \obiwan\, on the DECam CCDs used to Select ELG Targets for eBOSS}

We inject 1.2M simulated galaxies (i.e. randoms), at a density of 2800 per deg$^2$ into the DR3--era CCDs for both the NGC and SGC regions. About 50\%, or 1400 per deg$^2$, of the injected galaxies pass the eBOSS NGC ELG target selection. The eBOSS ELG target densities in the NGC and SGC are 200 and 240 per deg$^2$, respectively, so our randoms galaxy sample (before source detection and \tractor, measurement) has 7--14x the density of the real galaxy sample. Fig. \ref{fig:number-density-eboss} shows the histograms of injected number density including footprint geometry and removing injected sources that are within 1\arcsec\, of an existing (real) source in the DR3--era \tractor\, catalogs. The maximum injected number density is 2800 per deg$^2$, but the mean is less than this ($\sim 2200$ per deg$^2$) because we remove simulated galaxies from our final catalog that are within 1\arcsec\, of DR3--era \tractor\, sources. The distribution is bimodal because bricks at the edge of the footprint cannot receive as many sources, and areas are computed over the entire brick.
%, so we are injecting, on average, X ELGs / deg$^2$ which will be reduced further by whichever \legacypipe detects and models. Heatmaps of the number density of simulated galaxies added to each brick are shown in Fig. \ref{fig:number-density-eboss}. 

\begin{figure}
\begin{center}
 \includegraphics[width=\columnwidth]{figs/num_dens_injected}
\end{center}
 \caption[Number density of injected galaxies]{Number density of injected galaxies. (Right Column) Heatmaps showing number density of all injected sources in the NGC (top) and SGC (bottom) footprints. (Left Column) Number densities per brick of injected sources in the NGC (solid) and SGC (dashed). The panels are for all sources (top) and eBOSS ELGs (bottom). The distributions are bimodal because bricks near footprint edges or holes have less sources. The smaller mode corresponds to bluer points in the right column.}
 \label{fig:number-density-eboss}
\end{figure} 

%\begin{figure}[h!]
%\begin{center}
%     \subfloat[NGC\label{a}]{
%       \includegraphics[width=\columnwidth]{figs/heatmap_num_dens_inj_eboss_ngc}
%     }
%     \\
%     \subfloat[SGC\label{a}]{
%       \includegraphics[width=\columnwidth]{figs/heatmap_num_dens_inj_eboss_sgc}
%     }
%     \\
%     \subfloat[Histograms of Injected Source Density (\#/deg$^2$)\label{a}]{
%       \includegraphics[width=\columnwidth]{figs/hist_num_dens_injected}
%     }
%\end{center}
%\caption[Number density of injected galaxies]{Number density of injected galaxies. (Top) NGC footprint. (Middle) SGC footprint. (Bottom) Number density histograms in the NGC and SGC for all injected galaxies (Left) and eBOSS NGC ELGs (Right). The histograms are bimodal because bricks near edges or holes in footprint have less sources. i.e. the smaller mode corresponds to the blue points in (a) and (b).}
%\label{fig:number-density-eboss}
%\end{figure}

Fig. \ref{fig:input} shows the \gb, \rband, and \zb\, mag histograms for the simulated galaxies before and after adding galactic extinction (left column), the distribution of injected $\rhalf$ (right top), and the distribution of ellipticity components e1, e2 (right middle). Galactic extinction is strongest for bluer wavelengths and it makes \gb\, magnitudes about 0.1 mag fainter. The mode for galaxy sizes  is $\rhalf  = 0.5$\arcsec\, because \tractor\, models most galaxies in our parents as type SIMP; ignoring the mode, the $\rhalf$ distribution extends from 0.2 to 2\arcsec\, with mean of 0.8\arcsec\,. These ellipticity components correspond uniform distributions for the position angle [0, 180) and minor to major axis ratio [0.2, 1.0]. Fig. \ref{fig:number-per-type} shows that \legacypipe\, is equally good at recovering exponential and \dev\, sources. The injected galaxies are 89\% exponential and 11\% \dev\,, and \legacypipe\, recovers 76\% of the exponentials and 73\% of the \dev.

\begin{figure}
\begin{center}
 \includegraphics[width=\columnwidth]{figs/input_ext_all}
\end{center}
 \caption[Properties of injected galaxies]{(Left Colum) \gb, \rband, \zb\, magnitude of injected sources (blue) and after adding galactic extinction to them (green). Extincted sources are fainter and the effect is stronger for bluer bands. (Right Top) $\rhalf$ of injected sources. (Right Middle) Ellipticity components, e2 versus e1, of injected sources.}
 \label{fig:input}
\end{figure}

%\begin{figure}
%\begin{tabular}{cc}
%      \gb, \rband, \zb\, magnitude & $\rhalf$, e1, e2 \\
%      % list of figures goes left to right, then down a row, ...
%      \includegraphics[width=0.45\columnwidth]{figs/grz_hist_input_ext_g} &
%      \includegraphics[width=0.45\columnwidth]{figs/hist_true_rhalf_input}
%      \\
%      \includegraphics[width=0.45\columnwidth]{figs/grz_hist_input_ext_r} &
%      \includegraphics[width=0.45\columnwidth]{figs/e1_e2_input_1panel}
%      \\
%      \includegraphics[width=0.45\columnwidth]{figs/grz_hist_input_ext_z} &
%      \\
%\end{tabular}
%\caption{(Left) \gb, \rband, \zb\, magnitude of injected sources (green) and after adding galactic extinction to them (blue). Extincted sources are fainter and the effect is stronger for bluer bands. (Right Top) $\rhalf$ of injected sources. (Right Middle) Ellipticity components, e2 versus e1, of injected sources.   
%    \label{fig:input}}
%\end{figure}

\begin{figure}
 \includegraphics[width=\columnwidth]{figs/number_per_type_input_rec_meas}
 \caption{Barplot comparing the number of injected galaxies to the number recovered by \legacypipe. The injected population is 89\% exponential and 11\% \dev\,, and \legacypipe\, recovers 76\% of the exponentials and 73\% of the \dev. This suggests that \legacypipe\, is equally good at recovering exponential and \dev\, sources.}
 \label{fig:number-per-type}
\end{figure}

\legacypipe\, modifies the simulated galaxy sample in three ways: true positives, false positives, and false negatives. True positives (recovered ELGs) are simulated ELGs that remain eBOSS ELGs using \legacypipe's measurements for them. False positives (contaminants) are simulated non--ELGs that pass target selection after \legacypipe\, measures them. False negatives (lost ELGs) are simulated ELGs that are either not detected (non--detections), have sufficient \tractor\, measurement error to fail target selection (measurement--error), or overlap CCD edge(s) and are removed by the {\tt{fracin}} cut (edge--overlap, see Section \ref{sec:biases-systematics}). 

Fig. \ref{fig:rec-lost-contam-mag} shows the \gb, \rband, \zb\, magnitude distributions for the recovered ELGs, contaminants, and lost ELGs. ELGs lost to measurement-error are, on average, the faintest of the simulated galaxies in \gb, \rband, and/or \zb. Contaminants and ELGs lost to non-detections and edge-overlap are a minority of the sample and have similar \gb, \rband, \zb\, mag distributions. Fig. \ref{fig:rec-lost-contam-color} shows the colors for recovered ELGs, contaminants, and lost ELGs. The top right panel shows the eBOSS color box. Most contaminants start at top left of the color box and scatter by $\sim 0.25$ mag to redder \rband-\zb\, colors. Measurement-error is the primary way that ELGs are lost. The colors of ELGs lost to non-detections are distributed over the full color box, so non-detection does not appear to correlate with color. ELGs lost to edge-overlap appear to have the same color distribution as full sample because whether or not a source overlaps a CCD edge does not depend on flux. 

\begin{figure}
\begin{center}
 \includegraphics[width=7 cm]{figs/rec_lost_contam_grz}
\end{center}
 \caption[Magnitude distributions of recovered ELGs, contaminants, and lost ELGs]{\gb, \rband, \zb\, magnitude histograms for the recovered ELGs, contaminants, and lost ELGs. ELGs lost to measurement--error are, on average, the faintest of the simulated galaxies in \gb, \rband, and/or \zb. Contaminants and ELGs lost to non--detections and edge--overlap are a minority of the sample and have similar \gb, \rband, \zb\, mag distributions. 
 %There are similar number of recovered ELGs and lost ELGs fail-ts for sources brighter than \gb < 22.5, \rband < 21.9, or \zb < 21.0, but there are many more lost ELGs fail-ts for fainter sources than that. The \gb, \rband, \zb\, distributions of contaminants, lost ELGs not-detected, and lost ELGs fracin-in are roughly uniform.
 }
 \label{fig:rec-lost-contam-mag}
\end{figure}

\begin{figure}
\begin{center}
 \includegraphics[width=\columnwidth]{figs/rec_lost_contam_gr_rz}
\end{center}
 \caption[Colors of recovered ELGs, contaminants, and lost ELGs]{Distributions of recovered ELGs, contaminants, and lost ELGs for the eBOSS color box, using the color scheme from Fig. \ref{fig:rec-lost-contam-mag}. (Left) true color of source. (Right) \tractor\, measured color. From top to bottom are recovered ELGs (blue), contaminants (green), ELGs lost to measurement--error (cyan), ELGs lost to non--detections (magenta), and ELGs lost to edge--overlap (yellow).}
 \label{fig:rec-lost-contam-color}
\end{figure}

We inject ELGs with the appropriate correlations among brightness, shape, and redshift. Fig. \ref{fig:redshifts-recovered} shows how the injected n(z) is modified by \legacypipe. The top panel shows that redshifts $z < 0.2$ and $z > 1.4$ are lost. The bottom panel shows that contaminants primarily enter at three redshift ranges: $z < 0.25$, $0.5 < z < 0.75$, and $1.2 < z< 1.35$.

\begin{figure}
 \includegraphics[width=\columnwidth]{figs/redshifts_recovered}
 \caption{How \legacypipe\, modifies n(z). (Left) Redshift PDF for injected galaxies (blue) compared to what ends up in the \tractor\, catalog created by \legacypipe\, (green). (Right) The fraction of sources in each redshift bin that are true eBOSS ELGs (green) and contaminants (magenta). Contaminants primarily enter at three redshift ranges: $z < 0.25$, $0.5 < z < 0.75$, and $1.2 < z< 1.35$.}
 \label{fig:redshifts-recovered}
\end{figure}

\subsection{The Angular Correlation Function}
\label{sec:results-cf}

To compute the angular correlation function with and without \obiwan, we select galaxies (DD) from the DR3--plus catalogs\footnote{\url{https://data.sdss.org/sas/ebosswork/eboss/sandbox/lss/catalogs/versions/1_1/eBOSS_ELG_full_ALL_v1_1.dat.fits}} and randoms (RR) from either the \obiwan--randoms or uniform--randoms catalogs. We apply the eBOSS ELG NGC cuts in Section \ref{sec:eboss-ts}, the veto masks
%\footprint{\url{https://trac.sdss.org/wiki/eBOSS/QGC/ELG/ELG_data\#VetoMasks}} 
from \cite{anand17}, and these cuts to remove sources in low depth imaging,
\begin{itemize}
\item \verb|psfdepth_g| $> 62.797$
\item \verb|psfdepth_r| $> 30.057$ 
\item \verb|psfdepth_z| $> 11.0$
\end{itemize}
We restrict the DD and RR datasets to the eBOSS 23 footprint 
%\footnote{\url{https://trac.sdss.org/wiki/eBOSS/QGC/ELG/ELG_data\#FootprintMasks}}
and $\text{Dec} > 14.05$, since this is where the datasets overlap the most. The angular separation ($\theta$) between a pair of points with (RA$_1$, Dec$_1$) and (RA$_2$, Dec$_2$) is,
\begin{align}
%\theta = \cos(\psi_1) \cos(\psi_2) \cos(\phi_1-\phi_2) + \sin(\psi_1)\sin(\psi_2),
\theta = \cos(\psi_1) \cos(\psi_2) \lb \cos(\phi_1)\cos(\phi_2)+\sin(\phi_1)\sin(\phi_2) \rb + \sin(\psi_1)\sin(\psi_2),
\end{align}
\noindent where $\psi = (-\text{Dec}+90) \,\pi/180$ and $\phi = \text{RA} \times \pi/180$. We compute the ACF using the \cite{landy93} estimator (see Eqn. \ref{eqn:landy93}). We compute $w(\theta)$ at 27 evenly spaced logarithmic $\theta$ bins, centered between 10$^{-2}$ and 5 deg. The mean redshift of the eBOSS ELG n(z) is $z \sim 0.8$. For a $\Lambda CDM$ cosmological model with $\Omega_K = 0$ and $\Omega_m = 3$, this corresponds to $\sim 50$ Mpc per degree, so our $\theta$ bins span $\sim$ 0.5--250 Mpc.

Fig. \ref{fig:cf} (top panel) compares the ACF for \obiwan-randoms (the new method proposed in this paper) to that for uniform-randoms (when $RR(\theta)$ is only modified by the footprint geometry). The \obiwan-randoms ACF agrees well with the ELG mock catalog ACF (black) \cite{corrfuncEboss}, while the uniform-randoms ACF is too large. Weighting by $\theta$ (middle and bottom panels) shows that the \obiwan-randoms ACF behaves reasonably for $\theta \le 5$ deg, while the ELG mock catalog ACF breaks down for $\theta > 1$ deg. This break down occurs because the mean (but not the variance) of the ELG mock catalog ACF is biased for $\theta > 0.5$ deg \citep{corrfuncEboss}. \obiwan's improvement over uniform--randoms is particularly evident for $\theta > 0.1$ deg.

\begin{figure}
     \subfloat[\label{fig:w-theta}]{
       \includegraphics[width=\columnwidth]{figs/corrfunc_eboss23_w_theta}
     }
     \hfill
     \subfloat[\label{fig:thetaw-theta}]{
       \includegraphics[width=\columnwidth]{figs/corrfunc_eboss23_wtheta_theta}
     }
     \hfill
     \subfloat[\label{fig:thetaw-theta-zoom}]{
       \includegraphics[width=\columnwidth]{figs/corrfunc_eboss23_wtheta_theta_zoom}
     }
\caption{Angular correlation functions. Red uses \obiwan-randoms for RR and is the new method proposed in this paper, magenta uses uniform-randoms for RR, and black is the ELG mock catalog correlation function, blue uses \obiwan-randoms as a weight for uniform-randoms in a per brick size. We use 27 evenly spaced logarithmic $\theta$ bins, centered between 10$^{-2}$ and 5 deg. (Top) $w(\theta)$ versus $\theta$. (Middle) $\theta \times w(\theta)$ versus $\theta$. (Bottom) Zoom in on Middle plot.}
\label{fig:cf}
\end{figure}

Each data point in Fig. \ref{fig:cf} is the average ACF, $\overline{w(\theta)}$. The error bars come from Jackknife sampling, as discussed in Section \ref{eboss:methods-cf}, using $N_{sub} = 20$ equal area subsamples (Healpix pixels). There are thousands of galaxy--galaxy pairs per subsample so we can ignore the chance fluctuation contribution to $\sigma_{\rm{w(\theta)}}$. 

By estimating $\sigma_{\rm{w(\theta), Jack}}^2$ with Jackknife sampling we may be overestimating $\sigma_{\rm{w(\theta)}}$ by up to 25\% \cite{corrfuncErrors}. We are assuming that our $N_{sub}$ $w(\theta)$ measurements, for each bin in $\theta$, are Gaussian distributed \cite{corrfuncHamilton}. The Central Limit Theorem says that a statistic measured for any distribution will be Gaussian distributed as long as that statistic is measured enough times. \cite{astroML} suggests that 32 is a good rule of thumb, but it depends on the problem size. We use $N_{sub} = 20$, so this may bias our Jackknife estimates for $\sigma_{\rm{w(\theta), Jack}}^2$; however, small biases in our uncertainties on $\sigma_{\rm{w(\theta), Jack}}^2$ do not impact the interpretation that \obiwan\, drastically improves the ACF.

%The resulting correlation function is systematically over- and under-dense at different scales due to correlations between galaxy counts and imaging systematics, such as stellar density, seeing, galactic extinction, etc. (Ross et al papers). The correlation function is the expectation value of the number of galaxy pairs, so it is intuitive to write it as a weighted sum, where each weight represents the fraction of those pairs that are over- or under-represented in the sample.

\subsection{Imaging Systematics}

We tested how \obiwan \, recovers different imaging systematics. We divide each systematics value into 10 bins. For each bin, we compute the normalized total number of galaxies $n_{gal}(i)$ and normalized total number of \obiwan \, or uniform randoms $n_{ran}(i)$. The value in each bin is $n_{gal}(i)$/$n_{ran}(i)$. Assuming Poisson noise for galaxies and randoms, the error for each value is computed by
\begin{equation}
(\frac{n^2_{gal}(i)}{n^2_{ran}(i)}+\frac{n^2_{gal}(i)}{n^3_{ran}(i)}\frac{N_{ran}}{N_{gal}})^\frac{1}{2}
\end{equation}
where $N_{gal}$ and $N_{ran}$ are total number of galaxies and randoms respectively. Fig. \ref{fig:imaging-systematics} is a set of different kinds of imaging systematics. From the $\chi^2$ test, we can see that \obiwan \, improved a lot in all kinds of imaging systematics. \obiwan \, is able to handle the complexities for imaging systematics like the correlation between different properties. For example, there is a correlation between stellar density and galactic extinction because they both trace the structure of the Milky Way. \obiwan\, naturally includes all correlations between the maps. In many cases, e.g., PSFFWHM, the maps are of quantities that we hypothesize could affect our ability to extract sources from the images. \obiwan\, naturally represents a superset of all possible maps and removes the need to identify and classify multiple effects on source detection and measurement. Thus, compared to a map-based multivariate regression (e.g., \cite{anand17}), using \obiwan\, represents a simpler, and more complete, method for modeling systematic effects related to the detection and measurement of photometric properties of galaxies.

\begin{figure*}
\begin{center}
\includegraphics[width=\textwidth]{figs/systematics.png}
\caption{Number density fluctuations in \obiwan \, and uniform randoms as a function of different imaging systematics. Red compares galaxy data with \obiwan \,randoms. Blue compares galaxy data with uniform randoms. Each data point is the normalized number density of galaxies divided by normalized number density of \obiwan \, or uniform randoms. The $\chi^2$ test shows how the total distribution deviates from the black dotted reference line.}
\label{fig:imaging-systematics}
\end{center}
\end{figure*}

\subsection{Weight-based Methods}

Although computing the angular correlation function with \obiwan\, does not require weight--maps, various weight maps can be derived from \obiwan's results. The maps can be used by map--based methods for removing imaging systematics or to create ``mocks'' (i.e. mock data sets from N--body simulations for the evolution of dark matter in the universe) for estimating the variance of arbitrary ACF measurements. 

We limit ourselves to the following three weight maps: 
\begin{itemize}
\item {\it{Recovered}}: the fraction of all injected sources that \legacypipe\, detects and measures
\item {\it{Recovered NGC--ELGs}}: fraction of true NGC eBOSS ELGs that \legacypipe\, detects and measures and that have \tractor\, measurements that pass NGC eBOSS ELG target selection
\item {\it{Anymask--Allmask--Ratio}}: using \tractor\, measurements, the ratio of the number of sources that pass NGC eBOSS ELG target selection using \verb|allmask_grz = 0| to the number of when using \verb|anymask_grz = 0|
\end{itemize}
The resolution of each weight--map is the brick--scale of $\sim 0.25 \times 0.25$ deg. Fig. \ref{fig:weight-maps} shows these three weight--maps from top to bottom. 

\begin{figure}
\begin{center}
 \includegraphics[width=\columnwidth]{figs/heatmaps_all_three}
\end{center}
 \caption[\obiwan--derived weight--maps for all imaging systematics]{Weight--maps of imaging systematics that can be used by map--based methods for removing imaging systematics or to create mocks for estimating the variance of arbitrary ACF measurements. (Top) The fraction of all injected sources that \legacypipe\, detects and measures. (Middle) The fraction of true NGC eBOSS ELGs that \legacypipe\, detects and measures and that have \tractor\, measurements that pass NGC eBOSS ELG target selection. (Bottom) Using \tractor\, measurements, the ratio of the number of sources that pass NGC eBOSS ELG target selection using $\text{anymask} \, \text{grz} = 0$ to the number of when using $\text{allmask} \, \text{grz} = 0$.}
 \label{fig:weight-maps}
\end{figure}

%\begin{figure}
%     \subfloat[Recovered\label{a}]{
%       \includegraphics[width=\columnwidth]{figs/heatmap_recovered_eboss_ngc}
%     }
%     \hfill
%     \subfloat[Recovered NGC-ELGs\label{a}]{
%       \includegraphics[width=\columnwidth]{figs/heatmap_recovered_ngc_elgs_eboss_ngc}
%     }
%     \hfill
%     \subfloat[Anymask-Allmask-Ratio\label{a}]{
%       \includegraphics[width=\columnwidth]{figs/heatmap_anymask_allmask_ratio_ngc_elgs_eboss_ngc}
%     }
%\cprotect\caption{Weight-maps of imaging systematics that can be used by map-based methods for removing imaging systematics or to create mocks for estimating the variance of arbitrary ACF measurements. (Top) The fraction of all injected sources that \legacypipe\, detects and measures. (Middle) The fraction of true NGC eBOSS ELGs that \legacypipe\, detects and measures and that have \tractor\, measurements that pass NGC eBOSS ELG target selection. (Bottom) Using \tractor\, measurements, the ratio of the number of sources that pass NGC eBOSS ELG target selection using \verb|allmask_grz = 0| to the number of when using \verb|anymask_grz = 0|.}
%\label{fig:weight-maps}
%\end{figure}

In the Recovered map, lower fractions are generally due to fewer CCDs (see Fig. \ref{fig:ccds-eboss}); however, the Recovered NGC--ELG map is more complicated as lower fractions occur in regions with few CCDs (top right) as well as in regions with many CCDs (bottom left). The Recovered NGC--ELG map shows that only 20--40\% of true NGC ELGs end up passing eBOSS NGC ELG target selection. The fraction is so low because it includes all of the losses due to bright stars and bad--pixels, blending, and source detection and \tractor\, measurement error for galaxies with ELG brightness and color distributions. The Anymask--Allmask--Ratio map shows that the \verb|anymask_grz = 0| cut always selects fewer ELGs than \verb|allmask_grz = 0| and that this reduction is enhanced where there are more CCDs (i.e. deeper imaging does not necessarily help). On average, \verb|anymask_grz = 0| is a 10\% effect, but in regions with more CCDs it can be as large as 40\%. Most concerning is that the 40\% effect also occurs over the entire footprint and that it appears to be periodic on scales of $\sim 1$--$5$ deg. Remember, the BAO signal at redshift 1 is $\sim 5$ deg. Using just eBOSS ELG data it is unclear how to propagate the effects of the \verb|anymask_grz = 0| cut, so \obiwan\, may prove crucial to eBOSS ELG science.

%The power of \obiwan\, is evident in Fig. \ref{fig:frac-recovered-eboss}. The heat maps show the fraction of injected galaxies that \legacypipe\, recovers. It is no longer necessary to determine N weights for up- and down-sampling using linear fits to galaxy correlations with N systematics. Fig. \ref{fig:frac-recovered-eboss} is the weights, per brick.

\section{\legacypipe\, Biases and Systematics}

Our \obiwan\, eBOSS data reveal many biases and systematics in the \legacypipe\, pipeline. These are high impact items for the Legacy Surveys, but they are not relevant to this study. We direct the interested reader to Section \ref{sec:biases-systematics}. 


\section{Conclusions}
\label{sec:conclusions}

We summarize our conclusions as follows:
\begin{enumerate}
\item We proposed a new method for removing imaging systematics from galaxy survey data that does not  require maps of imaging systematics or foregrounds, and that removes any biases and systematics in the pipeline producing the large--scale--structure catalog.
\item We applied to this method to the eBOSS ELG sample using the \obiwan\, code described in \cite{obiwanMethods}. The resulting angular correlation function reproduces the ELG mock catalog correlation function \citep{corrfuncEboss} for $\theta < 1$ deg, and extends the correlation function to $\theta < 5$ deg.
\item We determined the \gb, \rband, \zb--mag distributions for recovered ELGS (true ELGs that remain ELGs after source detection and measurement), contaminants (non--ELGs that pass target selection after detection and measurement), and lost ELGs (ELGs that are not detected, fail target selection after measurement, or overlap CCD edges). We also investigated how much scattering occurs ($\sim 0.25$ mag) into and out of the eBOSS ELG color box and \gb--band mag limits. 
\item We provide weight--maps of imaging systematics that can be used by map--based methods to remove imaging systematics and reproduce our results. This includes a map of the ratio of the number of sources that pass ELG target selection using \verb|allmask_grz = 0| to the number when using \verb|anymask_grz = 0|, a result that may be crucial to eBOSS ELG science.
\item Finally, we identified numerous biases and systematics in the Legacy Surveys image reduction pipeline, \legacypipe. The highest impact ones are that \legacypipe\, underestimates the uncertainty on \gb, \rband, and \zb\, flux by a factor of 1.75--2, the uncertainty on $\rhalf$ by a factor of 3--5, and the uncertainty on e1 and e2 by a factor of 2.7--3. 
\end{enumerate}

\section*{Acknowledgements} 
\label{sec:ack}

Funding for the DEEP2 Galaxy Redshift Survey has been provided by NSF grants AST-95-09298, AST-0071048, AST-0507428, and AST-0507483 as well as NASA LTSA grant NNG04GC89G.
 
 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%% REFERENCES %%%%%%%%%%%%%%%%%%

% The best way to enter references is to use BibTeX:

\bibliographystyle{mnras}  %{mnras} if file is mnras.bst
\bibliography{bib} % {bib} if file is bib.bib


% Alternatively you could enter them by hand, like this:
% This method is tedious and prone to error if you have lots of references
%\begin{thebibliography}{99}
%\bibitem[\protect\citeauthoryear{Author}{2012}]{Author2012}
%Author A.~N., 2013, Journal of Improbable Astronomy, 1, 1
%\bibitem[\protect\citeauthoryear{Others}{2013}]{Others2013}
%Others S., 2012, Journal of Interesting Stuff, 17, 198
%\end{thebibliography}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%% APPENDICES %%%%%%%%%%%%%%%%%%%%%

\appendix

\section{Biases and Systematics (\legacypipe)}
\label{sec:biases-systematics}

This section describes the biases and systematics that we find in \legacypipe\, after running \obiwan\, on eBOSS data. Fig. \ref{fig:confusion} shows that \tractor\, is biased towards EXP sources. About 95\% of true exponential sources are modeled as exponential, while 20\% of true \dev\, sources are modeled as \dev. The other 80\% of truly \dev\, sources are classified as SIMP (50\%), EXP (20\%), and PSF (10\%). The EXP bias is surprisingly because \tractor\, model selection penalizes EXP and DEV sources equally (see \citealt{obiwanMethods}).
%(see Section \ref{obiwan-methods:tractor}). 
Fig. \ref{fig:rhalf-input} (top and middle) shows the distributions of true $\rhalf$ for sources classified as PSF, SIMP, EXP, and DEV by \tractor. The most common size is $\rhalf \sim 0.5$\arcsec; this is also most common recovered source size, even among non-SIMP sources. Source size most likely does not cause the EXP bias because the $\rhalf$ distributions for EXP and DEV sources are very similar. 
%DEV sources have a higher fraction of small ($rhalf < 0.5$\arcsec) sources than SIMP or EXP.
Fig. \ref{fig:rhalf-input} (bottom) shows the fraction of all sources recovered by \legacypipe\, versus true $\rhalf$. There is a characteristic size ($\rhalf \sim 1.5$\arcsec) after which the fraction recovered drops to, and fluctuates about, 50\%.

\begin{figure}
\begin{center}
 \includegraphics[width=\columnwidth]{figs/confusion_matrix_by_type}
\end{center}
 \caption[Confusion matrix for \tractor\, model selection]{Confusion matrix showing the fraction of true exponential or \dev\, sources that \tractor\, models as type PSF, SIMP, EXP, DEV, or COMP. \tractor\, is biased towards EXP sources. \tractor\, is biased towards EXP sources because 95\% of true exponential sources are modeled as exponential, while 20\% of true \dev\, sources are modeled as \dev.}
 \label{fig:confusion}
\end{figure}


\begin{figure}
\begin{center}
 \includegraphics[width=\columnwidth]{figs/true_rhalf_fraction_rec}
\end{center}
 \caption[Injected $\rhalf$ distributions and fraction recovered]{(Top) Injected $\rhalf$ distributions for sources classified as EXP and DEV by \tractor. (Middle) Same but sources classified as PSF and SIMP. (Bottom) Fraction of all sources recovered by \legacypipe\, versus injected $\rhalf$.}
 \label{fig:rhalf-input}
\end{figure}


Fig. \ref{fig:tractor-uncertainty} shows the number of standard deviations ($N_\sigma$) away from truth of the \tractor\, measured \gb, \rband, and \zb--band flux, $\rhalf$, and ellipticity e1 and e2. There are very large systematics offset in flux ($\sim 0.25$ mag in all bands) and $\rhalf$ ($\sim $3--4\arcsec\, for EXP and DEV sources), which we remove by subtracting the mean. \tractor\, fluxes are too faint while \tractor\, $\rhalf$ is too large. There is no systematic offset for the ellipticity e1 and e2 measurements. Reasons for these offsets are discussed in Section \ref{eboss:the-offset}. The least squares fit Gaussians (solid black) are considerably wider than a Normal Gaussian (dashed black). This suggests that all of \tractor\, measurement errors are underestimated, and by factors of 1.75--2x for \gb, \rband, \zb\, flux, 3--5x for $\rhalf$, and 2.7--3x for ellipticity e1 and e2.

\begin{figure*}
\begin{center}
\begin{tabular}{ccc}
      Flux & $\rhalf$ & e1, e2 \\
      % list of figures goes left to right, then down a row, ...
      \includegraphics[width=0.3\textwidth]{figs/num_std_dev_gaussfit_flux_separate_plots_g} &
      \includegraphics[width=0.3\textwidth]{figs/num_std_dev_gaussfit_rhalf_bytype_EXP_submean} &
      \includegraphics[width=0.3\textwidth]{figs/num_std_dev_gaussfit_e1_e2_EXP} 
      \\
      \includegraphics[width=0.3\textwidth]{figs/num_std_dev_gaussfit_flux_separate_plots_r} &
      \includegraphics[width=0.3\textwidth]{figs/num_std_dev_gaussfit_rhalf_bytype_DEV_submean} &
      \includegraphics[width=0.3\textwidth]{figs/num_std_dev_gaussfit_e1_e2_DEV} 
      \\
      \includegraphics[width=0.3\textwidth]{figs/num_std_dev_gaussfit_flux_separate_plots_z} 
      %\includegraphics[width=0.3\textwidth]{figs/num_std_dev_gaussfit_rhalf_bytype_SIMP_submean} &
      %\includegraphics[width=0.3\textwidth]{figs/num_std_dev_gaussfit_e1_e2_SIMP}
      \\
\end{tabular}
\end{center}
\caption{Number of standard deviations away from truth ($N_\sigma$) of the \tractor\, measured flux, $\rhalf$, and ellipticity. The mean of each distribution has been subtracted. The least squares fit Gaussians (solid black) are considerably wider than a Normal Gaussian (dashed black). This suggests that all of \tractor\, measurement errors are underestimated. (Left) $N_\sigma$  for \gb, \rband, \zb\, flux. (Middle) $N_\sigma$ for $\rhalf$ for sources \tractor\, classifies as EXP and DEV. (Right) $N_\sigma$ for ellipticity e1 and e2 for sources \tractor\, classifies as EXP and DEV. 
    \label{fig:tractor-uncertainty}}
\end{figure*}

Because the measurement uncertainty can dependent on \gb, \rband, \zb\, magnitude, we make 2--dimensional histograms of $N_\sigma$ for \gb, \rband, \zb\, flux versus \gb, \rband, \zb\, magnitude, respectively (Fig. \ref{fig:num-std-dev-and-dmag}, left panel); and magnitude residual versus versus \gb, \rband, \zb\, magnitude (Fig. \ref{fig:num-std-dev-and-dmag}, right panel). The results are nearly identical when only considering PSF, SIMP, EXP, or DEV sources.
%Relative bright sources have a smaller magnitude difference (interquartile range of 0.1--0.2) than relatively faint sources (interquartile range of 0.4--0.5 mag).

% Can't say the following because it could be do to N_\sigma being linear scale and mag residual being log scale!
%In terms of $N_\sigma$, the systematic offset  is constant with magnitude; in terms of the magnitude residual, the systematic offset is larger for fainter sources

\begin{figure*}
\begin{center}
\begin{tabular}{ccc}
      Number of Standard Deviations & Magnitude Difference \\
      % list of figures goes left to right, then down a row, ...
      \includegraphics[width=0.45\textwidth]{figs/num_std_dev_vs_grzmag_bytype_all} &
      \includegraphics[width=0.45\textwidth]{figs/dmag_vs_grzmag_bytype_all}
      \\
\end{tabular}
\caption{2--dimensional histograms of truth--\tractor\, residuals. (Left) $N_\sigma$ for \gb, \rband, \zb\, flux versus \gb, \rband, \zb\, magnitude, respectively. Yellow lines are the q25, 50, 75 percentiles. (Right) Magnitude residuals versus  \gb, \rband, \zb\, magnitude.}
\label{fig:num-std-dev-and-dmag}
\end{center}
\end{figure*}

We say \legacypipe\, recovers a injected source when there is exactly one \tractor\, catalog source within 1\arcsec\, of an injected source, and no DR3 \tractor\, catalog sources within 1\arcsec\, of the injected source. \obiwan\, injects sources at the nearest pixel center. This should lead to an RA and Dec offset, between the true centroid and \tractor's measurement, equal to the DECaLS pixel scale of 0.262\arcsec\, / pixel. The actual offset is $\sim 0.4$\arcsec\, (see Fig.\ref{fig:delta-radec}), which is larger than expected but still small enough that our 1\arcsec\, matching radius is fine. The larger offset is most likely due to co--registry and \tractor's simultaneous fitting of multiple images.

\begin{figure}
\begin{center}
 \includegraphics[width=\columnwidth]{figs/delta_dec_vs_delta_ra}
\end{center}
 \caption{2--dimensional histogram of RA and Dec residuals between the true centroid and \tractor's measurement of it. There is a systematic offset of 0.4\arcsec\, because \obiwan\, injects sources at the nearest pixel center.}
 \label{fig:delta-radec}
\end{figure}

%\obiwan\, provides a \tractor-independent measurement for depth. It is the magnitude of the source for which the chance of recovery (i.e. detecting it then deciding that it is a bonafide astrophysical source) is 50\% . Fig. \ref{fig:fraction-recovered} shows the fraction of exponential $\rhalf=0.5$\arcsec galaxies that are recovered by \legacypipe\, versus source magnitude for subset 60. The fraction is never less than 0.5 so subset 60 is more than 0.5 mag deeper than full-depth in all bands. This is good for our images of the COSMOS region, but bad for DECaLS because any conclusions that the DECaLS Team has derived from subset 60 will be too optimistic. 

% We can also ask, what magnitude source in these images becomes a 5\sigma detection with \tractor? (this depends on tractor flux ivar so is not independent of tractor)

\subsection{Edge-Sources}
\label{sec:edge-sources}

%t to arrive at the figures presented in Section \ref{sec:biases-systematics} identifies the bad sources and other biases and systematics that we remove from our . 
Fig. \ref{fig:dflux-systematic} (bottom right panel) reproduces Fig. \ref{fig:tractor-uncertainty} (left column), showing the number of standard deviations between true flux and \tractor\, measurement. The other panels in Fig. \ref{fig:dflux-systematic} illustrate the data cleaning required to go from raw \obiwan\, outputs (top left panel) to the cleaned \obiwan\, outputs (bottom right panel). The top left panel shows that there are many sources with $N_\sigma \approx 0$ and that there is an offset of a few standard deviations. The offset is discussed in Section \ref{sec:the-offset}. The sources with $N_\sigma \approx 0$ are sources that lie on top of CCD edges(s). They are linearly separable by {\tt{fracin}} $< 0.2$ (top right panel), which is the fraction of each source that overlaps its CCD(s). The bottom left panel shows the $N_\sigma \approx 0$ distribution for {\tt{fracin}} $< 0.2$ sources. The \zb--band measurements are particularly accurate. The bottom right panel shows the $N_\sigma$ distribution after removing {\tt{fracin}} $< 0.2$ sources and subtracting the mean. Note, the Legacy Surveys website\footnote{\url{http://legacysurvey.org/dr6/files}} says that {\tt{fracin}} is ``near unity for real sources''. This statement is incorrect; it is near unity for non-edge sources.

Why are \tractor's measurements very accurate (e.g. $N_\sigma \approx 0$) for {\tt{fracin}} $< 0.2$ sources? To test this we injected tens of galaxies onto the edges of three overlapping \gb, \rband, \zb\, CCDs, and found that if the source is detected \tractor\, can accurately reconstruct the full source profile even when less than 20\% of the profile is actually in the image. The background sky level is effectively zero because so much of the source falls off the CCD, so the variance of the flux measurement is much smaller than for a non-edge source. In principle, we should include the edge--sources in our analysis, but we drop them because we are interested in \legacypipe\, biases and systematics for the average source, not the relatively small sample of edge--sources. Fig. \ref{fig:safe-to-remove} shows that sources with {\tt{fracin}} $< 0.2$ and {\tt{fracin}} $\ge 0.2$ have similar \gb, \rband, \zb\, magnitude, $\rhalf$, and redshift distributions, so we do not bias our analysis by removing the edge--sources. Fig. \ref{fig:safe-to-remove} (bottom right panel) shows that $\sim 11$\% of truly exponential and \dev\, galaxies, respectively, are removed by the {\tt{fracin}} $< 0.2$ cut.

\begin{figure}
\begin{center}
     \subfloat[Including all data\label{fig:fracin-present}]{
       \includegraphics[width=0.5\columnwidth]{figs/num_std_dev_gaussfit_flux_bytype_all_notsubmean}
     }
     \subfloat[Edge--sources are linearly separable: {\tt{fracin}} $< 0.2$\label{fig:fracin-2dhist}]{
       \includegraphics[width=0.5\columnwidth]{figs/fracin_vs_numstddev_2dhist}
     }
     \\
     \subfloat[Including edge--sources only\label{fig:fracin-dflux}]{
       \includegraphics[width=0.5\columnwidth]{figs/num_std_dev_gaussfit_flux_bytype_all_keepwhatputin_fracin_keep_bad_020_notsubmean}
     }
     \subfloat[After removing edge--sources and subtracting the mean\label{fig:fracin-removed}]{
       \includegraphics[width=0.5\columnwidth]{figs/num_std_dev_gaussfit_flux_bytype_all_keepwhatputin_fracin_020}
     }
\end{center}
\caption{Illustration of the data cleaning required to go from raw to cleaned \obiwan\, outputs. (Top Left) The number of standard deviations ($N_\sigma$) between true flux and \tractor\, measurement. There is an offset of a few $N_\sigma$ which corresponds to $\sim 0.25$ mag (see Fig. \ref{fig:num-std-dev-and-dmag}) and many sources have $N_\sigma \approx 0$ (these are edge-sources). (Top Right) The edge-sources are linearly separated by {\tt{fracin}} $< 0.2$, which is the fraction of each source that overlaps its CCD(s). (Bottom Left) The $N_\sigma$ distribution for sources with {\tt{fracin}} $< 0.2$. (Bottom Right) The $N_\sigma$ distribution after removing {\tt{fracin}} $< 0.2$ sources and subtracting the mean. This reproduces Fig. \ref{fig:tractor-uncertainty}.}
\label{fig:dflux-systematic}
\end{figure}

\begin{figure}
\begin{center}
 \includegraphics[width=\columnwidth]{figs/hist_all_quantities_fracin_cut}
\end{center}
 \caption{(Histograms) \gb, \rband, \zb\, magnitude, $\rhalf$, and redshift PDFs for sources with {\tt{fracin}} $< 0.2$ (blue) and {\tt{fracin}} $\ge 0.2$ (green). (Bottom Right) Fraction of injected exponential and \dev\, galaxies that are recovered by \legacypipe\, (orange) or remain after \legacypipe\, recovery and the cut on {\tt{fracin}} $< 0.2$ (blue). About $\sim 11$\% of truly exponential and \dev\, galaxies, respectively, are removed by the {\tt{fracin}} $< 0.2$ cut.}
 \label{fig:safe-to-remove}
\end{figure}

\subsection{The 0.25 mag offset}
\label{sec:the-offset}

Figs. \ref{fig:tractor-uncertainty} and \ref{fig:num-std-dev-and-dmag} show that there is a very large (0.25 mag) offset between true flux and \tractor\, measurement, for all \gb, \rband, and \zb\, bands, and that this offset does not strongly depend on source magnitude or its \sersic\, index. The offset is most likely explained by either imperfect sky subtraction or too small a stamp size for simulated sources. Potential problems with these explanations are that the latter should give a strong dependence on \sersic\, index, while the former should produce a larger offset in \gb--band due to the brighter sky. 

{\it{Imperfect sky subtraction}}. \legacypipe\, models and subtracts the background sky with a cubic--spline fit to the entire CCD. The spline model was assumed to be insensitive to bright sources, however, after producing DR5 we realized that the sky model was tracing bright extended galaxies. An improved sky model was used for DR6\footnote{\url{http://legacysurvey.org/dr6/description/}}, but we are stuck with the pre--DR6 model because we are simulating DR3--era \tractor\, catalogs, so a 0.25 mag offset is conceivable. 

{\it{Too small a stamp size for simulated sources}}. \obiwan\, draws each simulated source at the center of a 64$\times$64 pixel postage stamp. The largest simulated sources have $\rhalf = 2$\arcsec\, (see Fig. \ref{fig:rhalf-input}), and we assumed (incorrectly) that 64 pixels (16\arcsec\, with DECam) was large enough to enclose $> 99.9\%$ of the flux for any source. Fig. \ref{fig:sersic-profiles} shows how the fraction of enclosed flux depends on \sersic\, index. For $n = 1$, $99\%$ of the flux occurs at $2\, \rhalf$ and $99.9\%$ at $5\, \rhalf$. For $n = 4$, $99\%$ of the flux occurs at $6\, \rhalf$ and $99.9\%$ at $> 10\, \rhalf$. The largest $n=4$ sources have $10\, \rhalf = 20$\arcsec, which makes our 64$\times$64 pixel ($16x16$\arcsec) postage stamp too small. However, more than this must be going on because the same $\sim$ 0.25 mag offset is seen when only $\rhalf = 0.5$\arcsec\, sources are injected (see \citealt{obiwanMethods}).

\begin{figure}
\begin{center}
 \includegraphics[width=\columnwidth]{figs/sersic_profiles}
\end{center}
 \caption[\sersic\, Profiles]{\sersic\, profiles, showing the fraction of the flux contained in a given multiple of the half--light radius ($r_e$)}
 \label{fig:sersic-profiles}
\end{figure}

%{\it{A bug with the magnitude normalization in Galsim}}. 
%John is wondering about this because he remembers spending a long time on this issue


\section{Injecting Realistic eBOSS ELGs}

\subsection{ELG Targets}
\label{sec:input-sample}

We construct our sample of ELG--like eBOSS galaxies (the eBOSS sample) using the eBOSS--\tractor\, tables, described in Section \ref{sec:eboss-tractor}, as follows. We assume that all sources that \tractor \, classifies as type PSF are compact and/or unresolved galaxies. These sources should be reasonably well described by a pixelized PSF profile convolved with an exponential profile having $\rhalf = \text{avg}(\text{FWHM}) / 2)$, where the average is over all bands, so we reclassify them as such. We also reclassify SIMP sources as EXP and drop COMP sources because they comprise less than 1\% of the sample. 
%keep galaxies having reasonable \tractor\, measured $\rhalf$.

DEV galaxies are systematically larger and about 1 mag brighter than EXP in all bands (see Fig. \ref{fig:dev-brighter}), so we split the above sample into separate DEV and EXP samples. 
%We also drop all NGC galaxies (about 30\% of the sample) because the NGC \tractor catalogs are not complete to \gb $< 23.8$ mag (see Fig. \ref{fig:ngc-incomplete}), 0.025 - 0.1 mag brighter than the \gb\, limit for eBOSS ELGs. 
This yields 77,525 EXP and 7,439 DEV galaxies. 
% Johan: I only quote 77k eBOSS ELG, but it should be around 120k in the SGC (eboss 21 and 22) and 250k total (+eboss 23 and 25). 
We refer to this as our eBOSS sample. The full list of cuts we apply is:
%9\% of the original sample is DEV, but they fill in parameter space enough for use to model. 
\begin{itemize}
\item !NGC
\item \verb|z_flag == 1| 
\item $0 \le \text{redshift} \le 2$
\item \verb|brick_primary|
\item $\text{type} \neq \text{COMP}$
\item $\rhalf  > 0.131$\arcsec\, (Nyquist limit, one half of the DECam pixel scale)
\item (EXP) $\rhalf  < 2.5$\arcsec
\item (DEV) $\rhalf  < 5.0$\arcsec
\end{itemize}

%\clearpage

\begin{figure}
 \includegraphics[width=\columnwidth]{figs/dev_brighter}
 \caption{DEV galaxies are systematically larger and brighter than EXP galaxies. The PDFs are for EXP (blue) and DEV (red) sources for \gb, \rband, and \zb\, magnitude (top row), redshift (bottom left), and $\rhalf$ (bottom right).}
 \label{fig:dev-brighter}
\end{figure}

\begin{figure}
 \includegraphics[width=5 cm]{figs/ngc_incomplete}
 \caption{PDFs of the number of spectroscopically confirmed galaxies in the NGC (blue) and SGC (red), with DECam \gb\, magnitude  in the eBOSS selection boundaries. The NGC imaging does not reach the required depth of $g = 22.825$ mag.}
 \label{fig:ngc-incomplete}
\end{figure}

Because the SGC \gb \, mag PDF (see Fig \ref{fig:ngc-incomplete}) is a step function at $g = 22.825$, a Gaussian mixture model (GMM) will perform badly. The the number density of eBOSS ELGs is largest for fainter ELGs so we must model the faint tail well. To simulate drawing from the joint distribution of brightness, shape, and size, we bootstrap sample from the eBOSS sample.

\subsection{ELG Almost-Targets}
\label{a:eboss-almost-targets}

We construct our DR3--DEEP2 sample as follows. We match DEEP2 galaxies to the nearest DR3 tractor catalog sources using a 1\arcsec\, matching radius and keeping the nearest neighbor. We reclassify SIMP and PSF sources as EXP, just as we did for the eBOSS sample (see Section \ref{sec:input-sample}), and then apply the following cuts, 
\begin{itemize}
\item !NGC
\item $0 \le \text{redshift} \le 2$ (heliocentric--corrected)
\item \verb|brick_primary|
\item \gb, \rband, \zb $\text{flux} > 0$
\item \gb, \rband, \zb $\text{flux ivar} > 0$
\item $\text{type} \neq \text{COMP}$
\item $\rhalf  > 0.131$\arcsec\, (Nyquist limit, one half of the DECam pixel scale)
\item (EXP) $\rhalf  < 2.5$\arcsec
\item (DEV) $\rhalf  < 5.0$\arcsec
\end{itemize}

Fig. \ref{fig:dr3dp2-reproduces} compares the eBOSS and DR3--DEEP2 (cut to eBOSS ELG targets) samples for EXP galaixes by showing the PDFs for \gb, \rband, and \zb\, flux, redshift, and $\rhalf$. Fig. \ref{fig:dr3dp2-redshift} shows that for EXP galaxies, \gb, \rband, \zb, and $\rhalf$ depend on redshift in the same way for the eBOSS and DR3--DEEP2 samples. The PDFs in Fig. \ref{fig:dr3dp2-reproduces} and the redshift dependence in Fig. \ref{fig:dr3dp2-redshift} show that the DR3--DEEP2 and eBOSS samples are very similar for EXP galaxies. We see similar agreement for DEV galaxies. 

\begin{figure}
\begin{center}
 \includegraphics[width=\columnwidth]{figs/dr3dp2_reproduces}
\end{center}
 \caption[The eBOSS and DR3--DEEP2 samples]{PDFs of \gb, \rband, \zb, redshift, and $\rhalf$ for EXP galaxies. The eBOSS (red) and DR3--DEEP2 (blue) samples have very similar brightness, shape, and redshift distributions.}
 \label{fig:dr3dp2-reproduces}
\end{figure}

\begin{figure}
\begin{center}
 \includegraphics[width=\columnwidth]{figs/dr3dp2_redshift_trends}
\end{center}
 \caption[Redshift dependence of the eBOSS and DR3--DEEP2 samples]{2-dimensional contour plots showing how redshift depends on \gb, \rband, \zb\, mag and $\rhalf$ for EXP galaxies in the eBOSS (blue) and DR3--DEEP2 (red) samples.}
 \label{fig:dr3dp2-redshift}
\end{figure}

\noindent Because DR3--DEEP2 galaxies extend beyond the eBOSS selection boundaries, we can sample ELG--like galaxy properties in this region of parameter space and test how galaxies scatter into (e.g. from \tractor\, measurement error) into the eBOSS ELG sample. \tractor\, flux measurements are accurate to 0.1 -- 0.3 mag for \gb\, $\sim 22.9$ galaxies \citep{obiwanMethods}, so we keep DR3--DEEP2 SGC galaxies within 0.2 mag of the eBOSSS selection boundaries (\gb\, mag, $g-r$, $r-z$), which yields a sample of 1,064 EXP and 85 DEV galaxies. Fig. \ref{fig:dr3dp2-vs-eboss} compares the resulting eBOSS and DR3--DEEP2 sample properties for EXP and DEV galaxies.

\begin{figure}
\begin{center}
     \subfloat[type EXP\label{fig:dr3dp2-vs-eboss-exp}]{%
       \includegraphics[width=\columnwidth]{figs/dr3dp2_vs_eboss_exp}
     }
     \hfill
     \subfloat[type DEV\label{fig:dr3dp2-vs-eboss-dev}]{%
       \includegraphics[width=\columnwidth]{figs/dr3dp2_vs_eboss_dev}
     }
\end{center}
\caption[Comparison of our final eBOSS and DR3--DEEP2 samples]{Comparison of our final eBOSS and DR3--DEEP2 samples. In the PDFs of \gb, \rband, \zb mag, $\rhalf$, and redshift, the DR3--DEEP2 (red) sample extends about 0.2 mag to brighter and fainter sources than the eBOSS (blue) sample. (a) EXP galaxies. (b) DEV galaxies. The DR3--DEEP2 sample is noisy because there are only 85 DEV galaxies in the sample.}
\label{fig:dr3dp2-vs-eboss}
\end{figure}


\subsection{ELG Redshift Distribution}
\label{sec:final-eboss-sample}

We now describe our algorithm to jointly sample an eBOSS n(z) redshift and its associated brightness, shape, and size using our eBOSS and DR3--DEEP2 samples. The eBOSS n(z) is the distribution of spectroscopic redshifts from the eBOSS--\tractor\, tables weighted by spectroscopic completeness (1/TSR). We drop the NGC spectroscopic redshifts because the NGC imaging data is incomplete. To sample from n(z), we intentionally over--fit a 10 component GMM (see Fig. \ref{fig:nz}). We draw redshifts from n(z), dropping those outside the allowed redshift range [0,2], until there are N redshift samples. Each sample gets a unique id, which is an integer [1,N] that we call ``id''. For each of the N redshifts, we find the nearest redshift in our (EXP--DEV combined) DR3--DEEP2 sample, which acts an n(z)--weighted draw from ELG--like galaxies within 0.2 mag of the eBOSS selection boundaries. 

\begin{figure}
\begin{center}
     \subfloat[eBOSS SGC\label{fig:nz-eboss}]{%
       \includegraphics[width=\columnwidth]{figs/nz_eboss}
     }
     \\
     \subfloat[10 component GMM\label{fig:nz-eboss-fit}]{%
       \includegraphics[width=\columnwidth]{figs/nz_eboss_and_thefit}
     }
\end{center}
\caption{[n(z) for eBOSS ELGs](Left) n(z) from the eBOSS SGC region based on spectra in the eBOSS-\tractor\, tables. (Right) Same but over plotting 10,000 draws from our GMM (blue).}
\label{fig:nz}
\end{figure}

Next, we decide whether each galaxy should have an exponential or \dev\, profile using the followign chance model. We define an ELG as passing eBOSS ELG SGC target selection (see Section \ref{eboss:eboss-ts}). If the galaxy is an ELG, we find its nearest redshift in the EXP eBOSS sample (90\% of the time) or the DEV eBOSS sample (10\% of the time); if not, we trim the DR3--DEEP2 sample to galaxies that extends beyond the eBOSS ELG selection boundaries, and find its nearest redshift in the trimmed EXP DR3--DEEP2 sample (90\% of the time) or the trimmed DEV DR3--DEEP2 sample (10\% of the time). This yields a sample of ELG--like eBOSS galaxies with the desired redshift distributed. Fig. \ref{fig:final-eboss-sample-10k} shows the resulting \gb, \rband, \zb\, flux, redshift, and $\rhalf$ PDFs for 10,000 draws from the above chance model.

\begin{figure}
\begin{center}
 \includegraphics[width=\columnwidth]{figs/final_eboss_elg_sample_10k_draws}
\end{center}
 \caption[Properties for EXP and DEV sources that are supposed to be representative of ELG-like eBOSS galaxies]{Properties for EXP and DEV sources that are supposed to be representative of ELG-like eBOSS galaxies. The PDFs of \gb, \rband, \zb, redshift, and $\rhalf$ are from 10,000 draws from our chance model (see Section \ref{sec:final-eboss-sample}).}
 \label{fig:final-eboss-sample-10k}
\end{figure}

We add the following to our sample: a random RA and Dec coordinate (sampling from the unit sphere), a uniform random position angle and minor to major axis ratio, and a unique id (\verb|id_sample|) saying where the brightness and shape information came from which we call. \verb|id_sample| is the SDSS--ID (\verb|plate-mjd-fiberid|) if from the EXP or DEV eBOSS samples or the \tractor--ID (\verb|brickid--objid|) if from the  EXP or DEV DR3--DEEP2 samples. 


\section{Data Products}
\label{sec:data-products}

All data products are available at The National Energy Research Scientific Computing Center (NERSC), on Cori SCRATCH: \verb|/global/cscratch1/sd/kaylanb/obiwan_out/eboss_elg|


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


% Don't change these lines
\bsp	% typesetting comment
\label{lastpage}
\end{document}

% End of mnras_template.tex
