% mnras_template.tex
%
% LaTeX template for creating an MNRAS paper
%
% v3.0 released 14 May 2015
% (version numbers match those of mnras.cls)
%
% Copyright (C) Royal Astronomical Society 2015
% Authors:
% Keith T. Smith (Royal Astronomical Society)

% Change log
%
% v3.0 May 2015
%    Renamed to match the new package name
%    Version number matches mnras.cls
%    A few minor tweaks to wording
% v1.0 September 2013
%    Beta testing only - never publicly released
%    First version: a simple (ish) template for creating an MNRAS paper

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Basic setup. Most papers should leave these options alone.
\documentclass[a4paper,fleqn,usenatbib]{mnras}

% MNRAS is set in Times font. If you don't have this installed (most LaTeX
% installations will be fine) or prefer the old Computer Modern fonts, comment
% out the following line
\usepackage{newtxtext,newtxmath}
% Depending on your LaTeX fonts installation, you might get better results with one of these:
%\usepackage{mathptmx}
%\usepackage{txfonts}

% Use vector fonts, so it zooms properly in on-screen viewing software
% Don't change these lines unless you know what you are doing
\usepackage[T1]{fontenc}
\usepackage{ae,aecompl}


%%%%% AUTHORS - PLACE YOUR OWN PACKAGES HERE %%%%%

% Only include extra packages if you really need them. Common packages are:
\usepackage{graphicx}	% Including figure files
\usepackage{amsmath}	% Advanced maths commands
\usepackage{amssymb}	% Extra maths symbols
\usepackage{multicol}        % Multi-column entries in tables
\usepackage{bm}		% Bold maths symbols, including upright Greek
\usepackage{pdflscape}	% Landscape pages
\usepackage{natbib}
%\usepackage{usenatbib}

%%mine
%\usepackage{float}
%\usepackage[demo]{graphicx}

\usepackage[caption = false]{subfig}  %multiple pngs for one figure

\usepackage{trace}
\usepackage{listings}  %upgrade of "verbatim", allows text wrapping
\usepackage{alltt} %non-compiled text tool
\usepackage[normalem]{ulem} %allows underlined text wrap around to next line if too long
%\usepackage{hyperref} % bibtex fields hyperlinks
\usepackage{tablefootnote} %makes \footnote{} work when inside table (places at bottom page)
\usepackage{threeparttable} %need this so where put in table notes actually works

\usepackage[dvipsnames]{xcolor}
\newcommand{\red}[1]{{\textcolor{red}{[#1]}}}
\newcommand{\blue}[1]{{\textcolor{blue}{[#1]}}}
%\newcommand{\red}[1]{{\textcolor{red}{[#1]}}}
\newcommand{\magenta}[1]{{\textcolor{Magenta}{[#1]}}}
\newcommand{\aqua}[1]{{\textcolor{Aquamarine}{[#1]}}}
\newcommand{\green}[1]{{\textcolor{LimeGreen}{[#1]}}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%% AUTHORS - PLACE YOUR OWN COMMANDS HERE %%%%%

\newcommand{\p}{\partial}
\newcommand{\lp}{\left(}
\newcommand{\rp}{\right)}
\newcommand{\lb}{\left[}
\newcommand{\rb}{\right]}
\newcommand{\Lfig}{(\textit{Left})}
\newcommand{\Rfig}{(\textit{Right})}
\newcommand{\Tfig}{(\textit{Top})}
\newcommand{\Bfig}{(\textit{Bottom})}

\newcommand{\Nsrc}{N_{\rm{src}}}
\newcommand{\Nsky}{N_{\rm{sky}}}
\newcommand{\Nout}{N_{\rm{out}}}
\newcommand{\Rout}{R_{\rm{out}}}
\newcommand{\Ndith}{N_{\rm{dith}}}
\newcommand{\Nexp}{N_{\rm{exp}}}
\newcommand{\Nread}{N_{\rm{read}}}
\newcommand{\Fsrc}{F_{\rm{src}}}
\newcommand{\Fsky}{F_{\rm{sky}}}
\newcommand{\msky}{m_{\rm{sky}}}
\newcommand{\msrc}{m_{\rm{src}}}
\newcommand{\Atele}{A_{\rm{tele}}}
\newcommand{\Apix}{A_{\rm{pix}}}
\newcommand{\Neff}{N_{\rm{eff}}}
\newcommand{\Npix}{N_{\rm{pix}}}
\newcommand{\Ps}{P_{\rm{sc}}}
\newcommand{\texp}{t_{\rm{exp}}}
\newcommand{\tmin}{t_{\rm{min}}}
\newcommand{\tmax}{t_{\rm{max}}}
\newcommand{\texpmin}{t_{\rm{exp, min}}}
\newcommand{\texpmax}{t_{\rm{exp, max}}}
\newcommand{\seeing}{\sigma_{\rm{see}}}
\newcommand{\rhalf}{r_{\rm{half}}}
\newcommand{\magsrc}{m_{\rm{src}}}
\newcommand{\zpi}{ZP_i}
\newcommand{\ebv}{E(B-V)}
\newcommand{\toverhead}{t_{\rm{overhead}}}
\newcommand{\tread}{t_{\rm{read}}}
\newcommand{\tslew}{t_{\rm{slew}}}
\newcommand{\thexapod}{t_{\rm{hexapod}}}
\newcommand{\tdeg}{t_{\rm{deg}}}
\newcommand{\tdone}{t_{\rm{done}}}
\newcommand{\tperfect}{t_{\rm{perfect}}}
\newcommand{\tneed}{t_{\rm{need}}}
\newcommand{\tneedi}{t_{\rm{need, i}}}
\newcommand{\texpi}{t_{\rm{exp, i}}}
\newcommand{\tneedj}{t_{\rm{need, j}}}
\newcommand{\Nslow}{N_{\rm{eff \, < \,3}}}
\newcommand{\Nall}{N_{\rm{all}}}
\newcommand{\Npts}{N_{\rm{pts}}}

\newcommand{\texpo}{t_{\rm{exp, 0}}}
\newcommand{\Fsrco}{F_{\rm{src, 0}}}
\newcommand{\Fskyo}{F_{\rm{sky, 0}}}
\newcommand{\Apixo}{A_{\rm{pix, 0}}}
\newcommand{\Neffo}{N_{\rm{eff, 0}}}
\newcommand{\Kco}{K_{\rm{co}}}
\newcommand{\Aco}{A_{\rm{co}}}
\newcommand{\zpo}{ZP_0}
\newcommand{\zpt}{ZP}
\newcommand{\mskyo}{m_{\rm{sky, 0}}}
\newcommand{\msrco}{m_{\rm{src, 0}}}
\newcommand{\mdesione}{m_{\rm{desi, 1}}}
\newcommand{\mdesitwo}{m_{\rm{desi, 2}}}

\newcommand{\gdecam}{g_{\rm{decam}}}
\newcommand{\rdecam}{r_{\rm{decam}}}
\newcommand{\zdecam}{z_{\rm{decam}}}
\newcommand{\zmosaic}{z_{\rm{mosaic}}}
\newcommand{\gps}{g_{\rm{ps1}}}
\newcommand{\rps}{r_{\rm{ps1}}}
\newcommand{\zps}{z_{\rm{ps1}}}
\newcommand{\gi}{\gps - \rps}
\newcommand{\maperture}{m_{\rm{ap}}}

\newcommand{\ith}{i^{\rm{th}}}
\newcommand{\jth}{j^{\rm{th}}}

\newcommand{\seff}{\text{Survey}_{\rm{ineff}}}
\newcommand{\totalobs}{T_{\rm{obs}}}
\newcommand{\totalreobs}{T_{\rm{reobs}}}
\newcommand{\totalneed}{T_{\rm{need}}}

\newcommand{\logten}{\log_{\rm{10}}}
\newcommand{\Ne}{N_{\rm{e-}}}
\newcommand{\Nskye}{N_{\rm{sky, \, e-}}}
\newcommand{\imageskysub}{\text{Image} - \text{Sky}_{\rm{interp}}}
\newcommand{\mAB}{m_{\rm{AB}}}
\newcommand{\mskyAB}{m_{\rm{sky, AB}}}
\newcommand{\PSmag}{m_{\rm{PS1}}}
\newcommand{\RAgaia}{RA_{\rm{gaia}}}
\newcommand{\DECgaia}{DEC_{\rm{gaia}}}
\newcommand{\RAgood}{RA_{\rm{good}}}
\newcommand{\DECgood}{DEC_{\rm{good}}}
\newcommand{\radiff}{\Delta \text{Ra}}
\newcommand{\decdiff}{\Delta \text{Dec}}
\newcommand{\decrms}{\sigma_{\Delta \text{Dec}}}
\newcommand{\rarms}{\sigma_{\Delta \text{Ra}}}

\newcommand{\skycounts}{\text{Sky}_{e-}}
\newcommand{\skymag}{m_{\rm{sky}}}
\newcommand{\sigmasky}{\sigma_{\rm{sky}}}
\newcommand{\sigmaskyeff}{\sigma_{\rm{sky, eff}}}
\newcommand{\reltransp}{\text{transp}_{\rm{rel}}}
\newcommand{\phoff}{\text{phoff}}
\newcommand{\arcsectwo}{\text{arcsec}^2}
\newcommand{\Xo}{X_0}
\newcommand{\fwhmCP}{\text{FWHM}_{\rm{CP}}}
\newcommand{\fwhmMoffat}{\text{FWHM}_{\rm{Moffat}}}
\newcommand{\fwhmo}{\text{FWHM}_0}
\newcommand{\mdepth}{m_{\rm{depth}}}

\newcommand{\gb}{$g$}
\newcommand{\rband}{$r$}
\newcommand{\zb}{$z$}

\newcommand{\tractor}{{\tt Tractor}}
\newcommand{\legacypipe}{{\tt Legacypipe}}
\newcommand{\obiwan}{{\tt Obiwan}}
\newcommand{\sextractor}{{\tt Source Extractor}~}
\newcommand{\psfex}{{\tt PSFex}}
\newcommand{\sersic}{Sersic}
\newcommand{\dev}{de Vaucouleurs}


% Please keep new commands to a minimum, and use \newcommand not \def to avoid
% overwriting existing commands. Example:
%\newcommand{\pcm}{\,cm$^{-2}$}	% per cm-squared

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%% TITLE PAGE %%%%%%%%%%%%%%%%%%%

% Title of the paper, and the short title which is used in the headers.
% Keep the title short and informative.
\title[Image Simulations for eBOSS]{Removing Imaging Systematics from eBOSS using {\tt{Obiwan}}}

% The list of authors, and the short list which is used in the headers.
% If you need two or more lines of authors, add an extra line using \newauthor

\author[K. J. Burleigh]{
Kaylan J. Burleigh,$^{1,2}$ \thanks{E-mail: kaylanb@berkeley.edu (KJB)}
Hui Kong,$^{5}$
Johan Comparat,$^{3,4}$
John Moustakas,$^{6}$ 
\newauthor
Anand Raichoor,$^{7,8}$
Ashley Ross$^{5}$
\& David Schlegel$^{2}$
%Peter E. Nugent$^{1,2}$
%\newauthor
%Anna Patej, John Moustakas,$^{5}$, David J. Schlegel$^{2}$, Eddie F. Schlafly$^{2}$, 
%\newauthor and the Legacy Survey Teams
\\
%% List of institutions
$^{1}$Department of Astronomy, University of California at Berkeley, 501 Campbell Hall \#3411, Berkeley, CA 94720, USA\\
$^{2}$Lawrence Berkeley National Laboratory, One Cyclotron Road, Berkeley, CA 94720, USA\\
$^{3}$Departamento de Fisica Teorica, Universidad Autonoma de Madrid, Cantoblanco E-28049, Madrid, Spain \\
$^{4}$Instituto de F\'{i}sica Te\'{o}rica, (UAM/CSIC), Universidad Aut\'{o}noma de Madrid, Cantoblanco, E-28049 Madrid, Spain \\
$^{5}$Department of Physics, Ohio State University, 191 West Woodruff Avenue, Columbus, Ohio 43210, USA \\ 
$^{6}$Department of Physics \& Astronomy, Siena College, 515 Loudon Road, Loudonville, NY, USA 12211 \\
$^{7}$Institute of Physics, Laboratory of Astrophysics, Ecole Polytechnique F\'{e}d\'{e}rale de Lausanne (EPFL), Observatoire de Sauverny, CH-1290 Versoix, Switzerland \\
$^{8}$CEA, Centre de Saclay, IRFU/SPP, F-91191 Gif-sur-Yvette, France \\
}
%$^{4}$Department of Astronomy \& Astrophysics and Dunlap Institute, University of Toronto, Toronto, ON, M5S 3H4, Canada \\
%$^{5}$Department of Physics and Astronomy, Siena College, Loudonville, NY 12211, USA
%}


% These dates will be filled out by the publisher
\date{Accepted YYY. Received YYYY; in original form YYYY}

% Enter the current year, for the copyright statements etc.
\pubyear{2018}

% Don't change these lines
\begin{document}
\label{firstpage}
\pagerange{\pageref{firstpage}--\pageref{lastpage}}
\maketitle

% Abstract of the paper
\begin{abstract}
\begin{itemize}
\item We present the first application of \obiwan, a new method for removing imaging systematics from the DECaLS data (Burleigh \& Moustakas 2018, in prep), to remove these systematics from angular correlation functions.
\item Our goal is to measure the angular correlation function for eBOSS ELGs. This is a crucial test of how well \obiwan\, can improve BAO measurements. The DESI analysis will be more complicated than eBOSS, so this is a necessary step towards a proper scientific analysis for DESI.
\item We perform a trial run on X deg$^2$ of the DR5 footprint, and then run \obiwan\, on the actual eBOSS footprint.
\item We estimate the impact of \obiwan\, on the angular correlation function
\end{itemize}
\end{abstract}

% Select between one and six entries from the list of approved keywords.
% Don't make up new ones.
\begin{keywords}
methods: observational
\end{keywords}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%% BODY OF PAPER %%%%%%%%%%%%%%%%%%

\section{Introduction}

The imaging imaging systematics in SDSS turned out to be fairly independent of one another, so they could be removed with linear models for them (ashley's papers). However, the imaging systematics in the next generation of galaxy surveys (astronomy data sets) will be highly correlated. The data will come from a joint analysis of multiple telescopes' data and/or will have data of the same part of the sky collected over long timelines (months or years).

We want the measure the Baryonic Acoustic Oscillation (BAO) signal, but there are shortcomings in the current methods, such as having apriori knowledge of all the possible imaging systematics in the galaxy survey dataset. DESI will obtain spectra of about 30M galaxies that will be targeted based on multi-band imaging from three telescopes. eBOSS has already targeted and obtained spectra for about \# ELG galaxies, based on DECam data. People have already started confronting this issue, and the previous weight fitting was extended to multiple dimensions (features). Poole et al fit to 25 maps simultaneously.

This paper is the first analysis of large scale data, in this case for eBOSS and DESI, that uses \obiwan\, (Burleigh \& Moustakas 2018, in prep), which is a non-parametric method that corrects for the full covariance of imaging systematics. We perform a trial run on X deg$^2$ of the DR5 footprint, and then run \obiwan\, on the actual eBOSS footprint, restricting to the footprint described in \cite{anand17}. From these runs, we measure the impact of \obiwan\, on the primary science objectives of eBOSS and extrapolate to DESI. All data products are available at NERSC (see Section \ref{sec:data-products}).

\section{Methods}

\subsection{\obiwan}

The five images in Fig. \ref{fig:1000-words} show how Obiwan works. The process is identical to how the Legacy Survey Team produces their Public Data Releases, with one exception. Every time Legacypipe reads an image, we add sim- ulated sources to it. The pipeline doesn't know about the simulated sources so the source detection and model fitting procedure is unaltered. For more details see Burleigh \& Moustakas 2018, in prep. Fig. \ref{fig:examples-faint} show examples of real and simulated ELG-like galaxies with similar \gb \, magnitude that are near the DECaLS detection limit. 
%The ELGs are at our detection limits so visual inspection of single exposure images containing ELGs is challenging.

\begin{figure}
 \includegraphics[width=\columnwidth]{obiwan_1000_words}
 \caption{Example of \obiwan\, adding 4 simulated galaxies to a \gb, \rband, and \zb\, DECam image (200x200 pixels). The original image (top left) is modified by adding 4 simulated galaxies (top middle) to create the new image (top right), which {\tt{Tractor}} operates on. The model and residual images are the bottom panels. Two of the simulated galaxies (the more compact ones) have \dev profiles, while the other two have exponential profiles.}
 \label{fig:1000-words}
\end{figure}

\begin{figure}
 \includegraphics[width=\columnwidth]{fake_real_mosaic_istart_254}
 \caption{Real and simulated ELG-like galaxies near the DECaLS \gb \, detection limit, with similar \gb\, magnitude. The label for each image is on the left (R for real and F for fake or simulated) and its corresponding g-band magnitude is the number on the right. Each row is a single galaxy. The first column is a three color jpeg for easy visualization. The remaining columns are the per-band full resolution coadds for the \gb, \rband, \zb\, images and associated inverse variance maps. Consecutive rows of R and F (rows 1 and 2, 3 and 4, etc.) have similar g-band magnitude for a fair comparison. REPLACE WITH GALAXIES AT eBOSS G=22.9 LIMIT}
 \label{fig:examples-faint}
\end{figure} 

We add fake galaxies to the images at random locations, run \legacypipe, and repeat until there are many more simulated galaxies than real ones. The simulated galaxies that \legacypipe\, detects and models are the ``randoms" that a correlation function estimator would use. These randoms have been modified by the full covariance between all imaging systematics, those we expect such as stellar density and seeing, those previously unknown, and the biases and systematics inherit to the \legacypipe\, pipeline itself. 

\subsection{Inject Realistic ELGs}

Section \ref{sec:input-sample}

Our simulated galaxies must be a representative sample of real ELGs or else we cannot use them as randoms. The next section describes how we generate a representative sample by comparing \tractor\, catalogues from DR5 to  spectroscopically confirmed ELG galaxies from DEEP2.  

In this paper, we only concern ourselves with Emission Line Galaxies (ELGs). These are blue star forming galaxies that are spectroscopically identified by a strong OII emission line. The DEEP2 Galaxy Redshift Survey (DEEP2, references) collected one of the largest samples of ELG spectra to date, since the spectral resolution resolves the OII emission line. To model the real population of ELGs, we match our DR3 Tractor catalogues to the DEEP2 catalogues using a 1\arcsec matching radius.

This gives us a sample of ELGs with high confidence redshift (from DEEP2 spectra), brightness (g, r, z flux), and shape (half light radii, ellipticity) information. While the sample is biased by the DEEP2 selection function, the depth of DR5 imaging, and \tractor's ability to measure the centroid, brightness, and shape, this is as good as we can do with publicly available data. The best possible sample is probably to use Hyper Suprime-Cam Subaru Survey (HSC-SS) imaging in the DEEP2 fields (Hayashi et al. 2017, Mehta et al. 2017).

We model the redshift-brightness-shape parameter space with Gaussian Mixture Models (GMMs). DESI and eBOSS have different ELG target selection criteria so we create separate DESI and eBOSS samples. We then divide each of those into a \dev and Exponential galaxy sample, because we find that \dev, in all bands, are larger and one mag brighter than Exponential, on average. 

\subsection{Run \obiwan\, on the DECam CCDs used to Select ELG Targets for eBOSS}

We will use \obiwan\, to inject simulated galaxies into the DECam CCDs\footnote{\url{http://portal.nersc.gov/project/desi/users/kburleigh/obiwan/legacysurveydir_ebossdr3}} used to produce the DR3 and DR3-plus \tractor\, catalogues, which the eBOSS Team used to select ELG Targets \citep{anand17}. Fig. \ref{fig:ccds-eboss} shows these CCDs and we will only inject galaxies inside the blue box. 

\begin{figure}
     \subfloat[NGC\label{fig:ccds-ngc}]{%
       \includegraphics[width=\columnwidth]{ccdsused_eboss_ngc}
     }
     \hfill
     \subfloat[SGC\label{fig:ccds-sgc}]{%
       \includegraphics[width=\columnwidth]{ccdsused_eboss_sgc}
     }
\caption{The eBOSS NGC and SGC footprints (blue boxes) and the DECaLS CCDs from the \tractor\, catalogues that used to select ELG targets.}
\label{fig:ccds-eboss}
\end{figure}

We will use the current version of \legacypipe\,, not the two year old version that was actually used to create the DR3 \tractor\, catalogues; however, there is excellent agreement between DR3 and DR5 measurements of the same sources so using the current version will not bias our results. We will run \legacypipe\, with the \verb|--simp| option (this uses SIMP models instead of REX) and we force it to not drop any of the input CCDs (this ensures that we use the CCDs that eBOSS used for target selection).   

\subsection{Use the Angular Correlation Function to Gauge Scientific Impact}

The two point correlation function, applied to galaxy survey data, says whether the galaxies are clustered or under-dense, relative to a random distribution, at different length scales (i.e. separations between pairs of galaxies). The 2D (angular) correlation function is computed by measuring the positions of galaxies in images of the night sky. The 3D correction function combines the 2D information with the distance to each galaxy from Earth (e.g. measured from a spectrum).

Computing the correlation function reduces to counting all pairs of galaxies with separation falling within a given bin. \cite{landy93} showed that 

\begin{align}
\xi(\Delta s) = \frac{GG(\Delta s) - 2 GR (\Delta s) + RR (\Delta s)}{RR (\Delta s)} \label{eqn:lz93}
\end{align}

\noindent is an unbiased estimator for the correlation function, where galaxy-galaxy (GG), galaxy-random (GR), and random-random (RR) are the pair counts in separation ($\Delta s$) bins. We use a different notation than the literature, GG instead of DD (data-data) and GR instead of DR (data-random), because we want to emphasize that the data are images and we are performing all kinds of analyses to select a potentially biased sample of galaxies. The randoms are a sample of random locations on a unit sphere that are then modified by the same procedure used to select the galaxy sample.   

The resulting correlation function is systematically over- and under-dense at different scales due to correlations between galaxy counts and imaging systematics, such as stellar density, seeing, galactic extinction, etc. (Ross et al papers). The correlation function is the expectation value of the number of galaxy pairs, so it is intuitive to write it as a weighted sum, where each weight represents the fraction of those pairs that are over- or under-represented in the sample. In SDSS, a linear model was fit to each imaging systematic correlation and then used to up- or down-sample the number of galaxies depending on the value of the systematic(s) in the region of the image where the galaxies came from. We refer to this post-processing weighting procedure as the {\it{old method}}. We now describe our {\it{new method}} Monte Carlo simulation method, which does not require this weighting procedure. 

We add fake galaxies to the images at random locations, run {\tt{Tractor}}, and the fake galaxies recovered by the Tractor become the randoms. This is true if and only if the fake galaxies we inject are representative of the real ELG galaxies we are interested in for DESI science. These randoms have been modified by the full covariance between all imaging systematics. In principle, this includes systematics we didn't expect, not just stellar density, seeing, extinction, etc. as identified in previous studies.

\subsection{Biases and Systematics in \legacypipe}

\section{Results}

\subsection{Run \obiwan\, on the DECam CCDs used to Select ELG Targets for eBOSS}

We inject X simulated galaxies (i.e. randoms), at a density of X / deg$^2$ (X / brick) into the DR3-era CCDs. X\% of the injected galaxies are ELGs under the eBOSS ELG target selections, so we are injecting, on average, X ELGs / deg$^2$ which will be reduced further by whichever \legacypipe detects and models. Heatmaps of the number density of simulated galaxies added to each brick are shown in Fig. \ref{fig:number-density-eboss}. 

\begin{figure}
     \subfloat[NGC\label{fig:number-density-eboss-ngc}]{
       \includegraphics[width=\columnwidth]{heatmap_number_density_eboss_ngc}
     }
     \hfill
     \subfloat[SGC\label{fig:number-density-eboss-sgc}]{
       \includegraphics[width=\columnwidth]{heatmap_number_density_eboss_sgc}
     }
\caption{Number density of simulated galaxies in the NGC and SGC footprints. We inject 2400 galaxies / deg$^2$ in both footprints, of which X\% are eBOSS ELG targets. The eBOSS ELG target densities are 200 and 240 targets / deg$^2$ in the NGC and SGC, respectively, so the density of simulated ELGs is at least X times higher than the target density for real ELGs.}
\label{fig:number-density-eboss}
\end{figure}

Fig. \ref{fig:input}(left column) shows the \gb, \rband, and \zb\, mag histograms for the simulated galaxies (blue), and the shift to fainter magnitudes (green) from adding galactic extinction. Right right column shows the distributions of injected $\rhalf$ and ellipticity components. e1, e2 are drawn from uniform distributions of position angles [0, 180) and minor to major axis ratios [0.2, 1.0]. 

\begin{figure}
\begin{tabular}{cc}
      \gb, \rband, \zb\, magnitude & $\rhalf$, e1, e2 \\
      % list of figures goes left to right, then down a row, ...
      \includegraphics[width=0.45\columnwidth]{grz_hist_input_ext_g} &
      \includegraphics[width=0.45\columnwidth]{hist_true_rhalf_input}
      \\
      \includegraphics[width=0.45\columnwidth]{grz_hist_input_ext_r} &
      \includegraphics[width=0.45\columnwidth]{e1_e2_input_1panel}
      \\
      \includegraphics[width=0.45\columnwidth]{grz_hist_input_ext_z} &
      \\
\end{tabular}
\caption{(Left) \gb, \rband, \zb\, magnitude of injected sources (green) and after adding galactic extinction to them (blue). Extincted sources are fainter and the effect is stronger for bluer bands. (Right Top) $\rhalf$ of injected sources. The most common size is $\rhalf \sim 0.5$\arcsec. (Right Middle) Ellipticity components, e2 versus e1, of injected sources. These correspond to sampling from uniform distributions of position angles [0, 180) and minor to major axis ratios [0.2, 1.0].  
    \label{fig:input}}
\end{figure}

The injected galaxies are 89\% exponential and 11\% \dev\,, and \legacypipe\, recovers 76\% of the exponentials and 73\% of the \dev. This suggests that \legacypipe\, is equally good at recovering exponential and \dev\, sources.

\begin{figure}
 \includegraphics[width=\columnwidth]{number_per_type_input_rec_meas}
 \caption{Barplot comparing the number of galaxies injected versus recovered by \legacypipe. The injected population is 89\% exponential and 11\% \dev\,, and \legacypipe\, recovers 76\% of the exponentials and 73\% of the \dev. This suggests that \legacypipe\, is equally good at recovering exponential and \dev\, sources.}
 \label{fig:number-per-type}
\end{figure}

The power of \obiwan\, is evident in Fig. \ref{fig:frac-recovered-eboss}. The heat maps show the fraction of injected galaxies that \legacypipe\, recovers. It is no longer necessary to determine N weights for up- and down-sampling using linear fits to galaxy correlations with N systematics. Fig. \ref{fig:frac-recovered-eboss} is the weights, per brick.

\begin{figure}
     \subfloat[NGC\label{fig:frac-recovered-eboss-ngc}]{
       \includegraphics[width=\columnwidth]{heatmap_fraction_recovered_eboss_ngc}
     }
     \hfill
     \subfloat[SGC\label{fig:frac-recovered-eboss-sgc}]{
       \includegraphics[width=\columnwidth]{heatmap_fraction_recovered_eboss_sgc}
     }
\caption{Fraction of injected galaxies that \legacypipe\, recovers. Higher fractions are generally due to having more CCDs (Fig. \ref{fig:ccds-eboss}).}
\label{fig:frac-recovered-eboss}
\end{figure}

\legacypipe\, modifies the simulated galaxy sample in three ways: true positives, false positives, and false negatives. True positives (recovered ELGs) are simulated ELGs that remain eBOSS ELGs using \legacypipe's measurements for them. False positives (contaminants) are simulated non-ELGs that pass target selection after \legacypipe\, measures them. False negatives (lost ELGs) are simulated ELGs that \legacypipe\, fails to detect (not-detected), fail target selection after \legacypipe\, measures them (fail-ts), or are removed by the {\tt{fracin}} cut (fracin-cut; see Section \ref{a:biases-systematics}). The distributions of recovered ELGs, contaminants, and lost ELGs in the eBOSS color box are shown in Fig. \ref{fig:rec-lost-contam-color}. Their \gb, \rband, \zb\, magnitude distributions are shown in Fig. \ref{fig:rec-lost-contam-mag}.

\begin{figure}
 \includegraphics[width=\columnwidth]{rec_lost_contam_gr_rz}
 \caption{Distributions of recovered ELGs, contaminants, and lost ELGs in the eBOSS color box. (Left) true color of source. (Right) \tractor\, measured color. From top to bottom are recovered ELGs (blue), contaminants (green), lost ELGs fail-ts (cyan), lost ELGs not-detected (magenta), and lost ELGs fracin-cut (yellow). Most contaminants come from the upper left region of the color box. The primary reason for loosing ELGs is that the \tractor\, measurements fail target selection.}
 \label{fig:rec-lost-contam-color}
\end{figure}

\begin{figure}
 \includegraphics[width=7 cm]{rec_lost_contam_grz}
 \caption{\gb, \rband, \zb\, magnitude histograms for recovered ELGs, contaminants, and lost ELGs, using the color scheme from Fig. \ref{fig:rec-lost-contam-color}. There are similar number of recovered ELGs and lost ELGs fail-ts for sources brighter than \gb < 22.5, \rband < 21.9, or \zb < 21.0, but there are many more lost ELGs fail-ts for fainter sources than that. The \gb, \rband, \zb\, distributions of contaminants, lost ELGs not-detected, and lost ELGs fracin-in are roughly uniform.}
 \label{fig:rec-lost-contam-mag}
\end{figure}

The ELGs we inject have the appropriate correlations among brightness, shape, and redshift, so we can ask, how does \legacypipe\, modify the input n(z)? The top panel of Fig. \ref{fig:redshifts-recovered} shows that redshifts $< 0.2$ and $> 1.4$ are lost. The bottom panel shows the fraction of contaminants for different redshift bins.

\begin{figure}
 \includegraphics[width=0.7\columnwidth]{redshifts_recovered}
 \caption{(Top) PDF of redshift for injected ELGs (blue) and recovered ELGs (green). (Bottom) The fraction of the injected ELG sample that are recovered ELGs (green) compared to contaminants (magenta).}
 \label{fig:redshifts-recovered}
\end{figure}

\subsection{Use the Angular Correlation Function to Gauge Scientific Impact}

To simplify terminology, we use {\it{uniform randoms}} to refer to random positions in the footprint, and {\it{obiwan randoms}} to refer to the subset of uniform randoms that are recovered by {\tt{Tractor}}. We wish to test our method over a large footprint, so we ran \obiwan\, on about 500 deg$^2$ of the DR5\footnote{\url{http://legacysurvey.org/status/}} footprint, and present the resulting angular correlation functions in Section \ref{sec:dr5}. We build on these results in Section \ref{sec:eboss}, presenting correlation functions from running \obiwan on the eBOSS NGC and SGC footprints, excluding eboss25.

\subsubsection{Weight Maps}

Future studies that want to use \obiwan\, randoms for computing correlation functions can use the maps of fraction recovered (Fig. \ref{fig:frac-recovered-eboss}) as weights to up- and down-sample their randoms.

\subsubsection{eBOSS NGC and SGC Analysis}
\label{sec:eboss}

INSERT HUI's WORK

\subsection{Biases and Systematics in \legacypipe}

This section introduces the types of things we can test with \obiwan. references the obiwan methods paper and section results biases and sys.

Which simulated ELGs does \legacypipe\, detect and model? Are there biases and systematics? How do the \tractor\, measured properties differ from input truth? We answer all of these questions, but doing so requires lengthy discussion and many figures. In this section, we restrict ourselves to the questions with the highest impact for eBOSS science. All other biases and systematics in \legacypipe\, are presented in Section \ref{sec:biases-systematics}. Insights from both this section and Section \ref{sec:biases-systematics} are needed to properly analyze our \obiwan\, data set.

\begin{figure}
 \includegraphics[width=\columnwidth]{confusion_matrix_by_type}
 \caption{Confusion matrix showing the fraction of truly exponential or \dev\, sources that \tractor\, models as type PSF, SIMP, EXP, DEV, or COMP sources. About 95\% of exponential sources are modeled as such by tractor; however, only 20\% of the \dev\, sources are modeled as \dev\, with 50\% and 20\% modeled as SIMP and EXP, respectively. \tractor\, model selection penalizes EXP and DEV sources equally (Burleigh \& Moustakas et al. 2018), but \tractor\, is biased towards EXP sources. 20\% of \dev\, sources are modeled as EXP compared to only 5\% of exponential modeled as DEV.}
 \label{fig:confusion}
\end{figure}

Fig. \ref{fig:tractor-uncertainty} shows the uncertainties on \tractor\, measurements of flux, $\rhalf$, and ellipticity (e1, e2).

\begin{figure*}
\begin{center}
\begin{tabular}{ccc}
      Flux & $\rhalf$ & e1, e2 \\
      % list of figures goes left to right, then down a row, ...
      \includegraphics[width=0.3\textwidth]{num_std_dev_gaussfit_flux_separate_plots_g} &
      \includegraphics[width=0.3\textwidth]{num_std_dev_gaussfit_rhalf_bytype_EXP_submean} &
      \includegraphics[width=0.3\textwidth]{num_std_dev_gaussfit_e1_e2_EXP} 
      \\
      \includegraphics[width=0.3\textwidth]{num_std_dev_gaussfit_flux_separate_plots_r} &
      \includegraphics[width=0.3\textwidth]{num_std_dev_gaussfit_rhalf_bytype_DEV_submean} &
      \includegraphics[width=0.3\textwidth]{num_std_dev_gaussfit_e1_e2_DEV} 
      \\
      \includegraphics[width=0.3\textwidth]{num_std_dev_gaussfit_flux_separate_plots_z} &
      \includegraphics[width=0.3\textwidth]{num_std_dev_gaussfit_rhalf_bytype_SIMP_submean} &
      \includegraphics[width=0.3\textwidth]{num_std_dev_gaussfit_e1_e2_SIMP}
      \\
\end{tabular}
\end{center}
\caption{Residuals between truth and \tractor\, measurement. (Left column) Number of standard deviations away from truth of \tractor's \gb, \rband, \zb\, flux measurements. There is a systematic offset between \tractor\, and truth which we remove by subtracting the mean (see Section \ref{sec:biases-systematics}). \tractor's \gb, \rband, \zb\, flux errors are 1.75-2x larger than \tractor ivar implies and appear gaussian distributed. (Middle column) Number of standard deviations away from truth of \tractor's $\rhalf$ measurements. As with similar plots for flux, there is a systematic offset between \tractor\, and truth which we remove by subtracting the mean (see Section \ref{sec:biases-systematics}). {\it{Top:}} For type EXP, \tractor's $\rhalf$ errors are 3x larger than \tractor's ivar implies and appear gaussian distributed. {\it{Middle:}} DEV, errors appear gaussian distributed and about 5x larger than \tractor's ivar. {\it{Bottom:}} SIMP, \tractor's ivar is now an overestimate by a factor of 4. Most sources have $\rhalf \sim 0.5$\arcsec, but not all (Fig. \ref{fig:rhalf-by-type}). (Right column) Number of standard deviations away from truth of \tractor's ellipticity measurements (e1 on top, e2 on bottom). There is almost no offset between between \tractor\, and truth, but we still subtract the mean. {\it{Top:}} For type EXP, \tractor's e1 and e2 errors are 3x larger than \tractor's e1 ivar and e2 ivar imply and appear gaussian distributed. {\it{Middle:}} DEV, same as panel a but with lower error, about 2.7x larger than \tractor's e1 ivar and e2 ivar imply. {\it{Bottom:}} SIMP, true e1 $\sim$ e2 $\sim 0$ and \tractor\, measures these very accurately, about 5x better than \tractor's e1 ivar and e2 ivar would imply.
    \label{fig:tractor-uncertainty}}
\end{figure*}

Fig. \ref{fig:tractor-uncertainty} averages out any dependence on \gb, \rband, \zb\, magnitude, so we plot the number of standard deviations between truth and \tractor\, flux, and the magnitude residuals, versus \gb, \rband, \zb\, magnitude in Fig. \ref{fig:num-std-dev-and-dmag}.

\begin{figure*}
\begin{center}
\begin{tabular}{ccc}
      Number of Standard Deviations & Magnitude Difference \\
      % list of figures goes left to right, then down a row, ...
      \includegraphics[width=0.4\textwidth]{num_std_dev_vs_grzmag_bytype_all} &
      \includegraphics[width=0.4\textwidth]{dmag_vs_grzmag_bytype_all}
      \\
\end{tabular}
\caption{(Left) Number of standard deviations away from truth of \tractor's \gb, \rband, \zb\, flux measurements (assuming \tractor\, ivar) versus \gb, \rband, \zb\, magnitude. Yellow lines are the q25, 50, 75 percentiles. \tractor's inverse variances are too small (Fig. \ref{fig:tractor-uncertainty}) and by a nearly constant amount, independent of the magnitude of the source. We find identical results when remaking this figure for only PSF, SIMP, EXP, and DEV sources, respectively. \tractor\, fluxes are too faint as previously discussed for Fig. \ref{fig:tractor-uncertainty}. (Right) Magnitude difference between \tractor's flux measurements and truth versus \gb, \rband, \zb\, magnitude. Top to bottom is \gb, \rband, \zb\, residuals.  Yellow lines are the q25, 50, 75 percentiles. The interquartile range is 0.1-0.2 mag for bright sources and 0.4-0.5 mag for faint sources.}
\label{fig:num-std-dev-and-dmag}
\end{center}
\end{figure*}

We say \legacypipe\, recovers a injected source when there is exactly one \tractor\, catalogue source within 1\arcsec of an injected source, and no DR3 \tractor\, catalogue sources within 1\arcsec of the injected source. We chose a 1\arcsec matching radius because \obiwan\, injects sources at the nearest pixel center. This should lead to an RA and Dec offset, between the true centroid and \tractor's measurement, equal to the DECaLS pixel scale of 0.262\arcsec / pixel. Fig. \ref{fig:delta-radec} shows that the offset is larger (0.4\arcsec) but still small enough that 1\arcsec is fine. We think the larger offset is due to co-registry and \tractor's simultaneous fitting of multiple images.

\begin{figure}
 \includegraphics[width=7 cm]{delta_dec_vs_delta_ra}
 \caption{RA and Dec residuals (arcsec) between the true centroid and \tractor's measurement of it. There is a systematic offset of 0.4\arcsec because \obiwan\, injects sources at the nearest pixel center. The offset would be equal to the DECaLS pixel scale, 0.262\arcsec / pixel, but co-registry and simultaneous fitting of multiple images makes it larger.}
 \label{fig:delta-radec}
\end{figure}

Fig. \ref{fig:rhalf-recovered} shows that for $\rhalf > 1.5$\arcsec the chance of recovery drops to and fluctuates about 50\%.

\begin{figure}
 \includegraphics[width=0.7\columnwidth]{fraction_recovered_vs_rhalf}
 \caption{How the fraction of sources recovered by \legacypipe\, depends on the size of the source. $\rhalf \sim 1.5$\arcsec is the critical size after which the chance of recovery drops to and fluctuates about 50\%.}
 \label{fig:rhalf-recovered}
\end{figure}


%\obiwan\, provides a \tractor-independent measurement for depth. It is the magnitude of the source for which the chance of recovery (i.e. detecting it then deciding that it is a bonafide astrophysical source) is 50\% . Fig. \ref{fig:fraction-recovered} shows the fraction of exponential $\rhalf=0.5$\arcsec galaxies that are recovered by \legacypipe\, versus source magnitude for subset 60. The fraction is never less than 0.5 so subset 60 is more than 0.5 mag deeper than full-depth in all bands. This is good for our images of the COSMOS region, but bad for DECaLS because any conclusions that the DECaLS Team has derived from subset 60 will be too optimistic. 

% We can also ask, what magnitude source in these images becomes a 5\sigma detection with \tractor? (this depends on tractor flux ivar so is not independent of tractor)


\section{Plots to Make}
\begin{itemize}
\item galdepth vs. obi wan measured depth, where does the 20\% from validation fall?
\item n(z) resulting from different depths
\item autocorrelation functions for uniform-uniform rand, obiwan-obiwan rand
\item cross correlate everything: (DD=obiwan-rand, RR=uniform-rand), (DD=DR5, RR=uniform-rand), (DD=DR5, RR=obiwan-rand), compare DR5 correlation with known systematics to obiwan-rand with know systematics 
\item plots: BAO fit to angular CF 
\end{itemize}

\section{Conclusions}

\begin{itemize}
\item this is the way to assess bias/systematics when doing joint analysis of datasets from multiple telescopes
\end{itemize}


\section*{Acknowledgements} 
 
 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%% REFERENCES %%%%%%%%%%%%%%%%%%

% The best way to enter references is to use BibTeX:

\bibliographystyle{mnras}  %{mnras} if file is mnras.bst
\bibliography{bib} % {bib} if file is bib.bib


% Alternatively you could enter them by hand, like this:
% This method is tedious and prone to error if you have lots of references
%\begin{thebibliography}{99}
%\bibitem[\protect\citeauthoryear{Author}{2012}]{Author2012}
%Author A.~N., 2013, Journal of Improbable Astronomy, 1, 1
%\bibitem[\protect\citeauthoryear{Others}{2013}]{Others2013}
%Others S., 2012, Journal of Interesting Stuff, 17, 198
%\end{thebibliography}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%% APPENDICES %%%%%%%%%%%%%%%%%%%%%

\appendix

\section{Simulating eBOSS ELG Galaxies}
\label{sec:input-sample}

\subsection{ELGs Selected By eBOSS}
\label{sec:eboss-targets}

We use the joint tables (provided by Anand) of \tractor \, catalogue measurements for each eBOSS ELG target and the eBOSS spectra obtained for that target,
\begin{itemize}
\item \verb|eBOSS.ELG.obiwan.eboss21.v5_10_4.fits|
\item \verb|eBOSS.ELG.obiwan.eboss2122.v5_10_7.fits| 
\item \verb|eBOSS.ELG.obiwan.eboss22.v5_10_4.fits|
\item \verb|eBOSS.ELG.obiwan.eboss23.v5_10_4.fits|
\item \verb|eBOSS.ELG.obiwan.eboss23.v5_10_7.fits|
\end{itemize}

\noindent to construct a sample of eBOSS ELG targets each having a redshift, shape, and \gb, \rband, \zb flux. We assume that all sources \tractor \, classifies as type PSF are compact or unresolved galaxies. We reclassify them as EXP with $\rhalf = \text{avg}(\text{FWHM}) / 2)$, where the average is over all bands. We also reclassify SIMP sources as EXP. We drop COMP sources because these comprise less than 1\% of the sample. 
%keep galaxies having reasonable \tractor\, measured $\rhalf$.

DEV galaxies are systematically larger and about 1 mag brighter than EXP in all bands (see Fig. \ref{fig:dev-brighter}), so we split the above sample into separate DEV and EXP samples. Fig. \ref{fig:ngc-incomplete} also shows that the NGC region is not complete for the \gb \,mag of the eBOSS ELGs, so we throw out all the NGC galaxies (about 30\% of the sample). This yields 77,525 EXP and 7,439 DEV galaxies. We refer to this as our eBOSS sample. The full list of cuts we apply is:
%9\% of the original sample is DEV, but they fill in parameter space enough for use to model. 
\begin{itemize}
\item !NGC
\item \verb|z_flag == 1| 
\item $0 \le \text{redshift} \le 2$
\item \verb|brick_primary|
\item $\text{type} \neq \text{COMP}$
\item $\rhalf  > 0.131$\arcsec\, (Nyquist limit, one half of the DECam pixel scale)
\item (EXP) $\rhalf  < 2.5$\arcsec
\item (DEV) $\rhalf  < 5.0$\arcsec
\end{itemize}

\begin{figure}
 \includegraphics[width=\columnwidth]{dev_brighter}
 \caption{PDFs of \gb, \rband, \zb mag (top) and redshift and $\rhalf$ (bottom) for eBOSS ELG targets that are spectroscopically confirmed to be galaxies. DEV galaxies (red) are systematically larger and about 1 mag brighter than EXP galaxies, in all bands. We reclassify PSF sources as EXP with $\rhalf = \text{avg}(\text{FWHM}) / 2)$, where the average is over all bands.}
 \label{fig:dev-brighter}
\end{figure}

\begin{figure}
 \includegraphics[width=5 cm]{ngc_incomplete}
 \caption{The eBOSS NGC footprint is not deep enough to detect eBOSS ELGs with $g < 22.825$ mag. We remove galaxies in the NGC region from our sample of representative ELGs.}
 \label{fig:ngc-incomplete}
\end{figure}

Because the SGC \gb \, mag PDF in Fig \ref{fig:ngc-incomplete} is a step function for $g > 22.825$, a Gaussian Mixture model for the brightness, shape, and redshift distribution of eBOSS ELGs will be inaccurate at the faint \gb \, mag, where most of the ELGs reside. To model the full distribution of ELG properties we bootstrap sample from our eBOSS sample.

\subsection{ELGs Almost Selected By eBOSS}
\label{sec:eboss-almost-targets}

In addition to simulating eBOSS ELGs, we want to test contamination by injecting ELGs just outside of the eBOSS selection boundaries; however, the eBOSS sample does not extend beyond the selection boundaries. We create a DR3-DEEP2 matched sample using a 1\arcsec\, matching radius and keeping the nearest match. We reclassify SIMP and PSF sources as EXP the same way we did for the eBOSS sample (see Section \ref{sec:eboss-targets}), and then  apply the following cuts, 
\begin{itemize}
\item !NGC
\item INSERT DEEP2 FLAG THAT SAYS THE OBJECT IS A GALAXY
\item $0 \le \text{redshift} \le 2$
\item \verb|brick_primary|
\item \gb, \rband, \zb $\text{flux} > 0$
\item \gb, \rband, \zb $\text{flux ivar} > 0$
\item $\text{type} \neq \text{COMP}$
\item $\rhalf  > 0.131$\arcsec\, (Nyquist limit, one half of the DECam pixel scale)
\item (EXP) $\rhalf  < 2.5$\arcsec
\item (DEV) $\rhalf  < 5.0$\arcsec
\end{itemize}

We find that the DR3-DEEP2 sample reproduces the brightness, shape, and redshift distributions of the eBOSS sample. Fig. \ref{fig:dr3dp2-reproduces} shows the PDFs of \gb, \rband, \zb, redshift, and $\rhalf$ for EXP galaxies, and that the DR3-DEEP2 galaxies (cut to eBOSS ELG targets) agree very well with the eBOSS sample. Fig. \ref{fig:dr3dp2-redshift} shows that for EXP galaxies, \gb, \rband, \zb, and $\rhalf$ depend on redshift in the same way for the DR3-DEEP2 galaxies (cut to eBOSS ELG targets) and the eBOSS sample. A similar level of agreement occurs for DEV galaxies.

\begin{figure}
 \includegraphics[width=\columnwidth]{dr3dp2_reproduces}
 \caption{PDFs of \gb, \rband, \zb, redshift, and $\rhalf$ for EXP galaxies. The DR3-DEEP2 galaxies (blue), cut to type EXP galaxies, the SGC footprint, and eBOSS ELG targets, reproduces the brightness, shape, and redshift distributions of the eBOSS sample (red).}
 \label{fig:dr3dp2-reproduces}
\end{figure}

\begin{figure}
 \includegraphics[width=\columnwidth]{dr3dp2_redshift_trends}
 \caption{For EXP galaxies, \gb, \rband, \zb, and $\rhalf$ depend on redshift in the same way for the DR3-DEEP2 galaxies (red) and the eBOSS sample (blue). SWAP COLORS SO BLUE IS DR3-DP2 LIKE PREV FIG}
 \label{fig:dr3dp2-redshift}
\end{figure}

Because DR3-DEEP2 galaxies are representative of eBOSS ELGs and extend beyond the eBOSS selection boundaries, we can construct a sample of ELG-like galaxies to test contamination into the eBOSS selected sample. We choose to keep DR3-DEEP2 SGC galaxies within a padding of 0.2 mag of the eBOSSS selection boundaries, yielding a sample of 1,064 EXP and 85 DEV galaxies. Burleigh \& Moustakas 2018, in prep show that \tractor\, flux measurements are accurate to 0.1 - 0.2 mag for \gb $\sim 22.9$ galaxies, so a padding of 0.2 mag should capture most contaminants due to \tractor\, measurement errors. 

\subsection{Simulating eBOSS ELGs with the correct n(z)}
\label{sec:final-eboss-sample}

We now describe our algorithm for jointly sampling from the n(z) for eBOSS and from the eBOSS and DR3-DEEP2 samples described in Sections \ref{sec:eboss-targets} and \ref{sec:eboss-almost-targets}. Fig. \ref{fig:dr3dp2-vs-eboss} compares the eBOSS and DR3-DEEP2 samples for EXP and DEV galaxies.

\begin{figure}
     \subfloat[type EXP\label{fig:dr3dp2-vs-eboss-exp}]{%
       \includegraphics[width=\columnwidth]{dr3dp2_vs_eboss_exp}
     }
     \hfill
     \subfloat[type DEV\label{fig:dr3dp2-vs-eboss-dev}]{%
       \includegraphics[width=\columnwidth]{dr3dp2_vs_eboss_dev}
     }
\caption{PDFs of \gb, \rband, \zb mag, $\rhalf$, and redshift for galaxies from the eBOSS (blue) and DR3-DEEP2 (red) samples. (Top) EXP galaxies. (Bottom) DEV galaxies. The DR3-DEEP2 sample includes galaxies within 0.2 mag of the eBOSS ELG target selection boundaries, so it is brighter and fainter than the eBOSS sample. The DR3-DEEP2 DEV are noisy because the sample size is so small (85 galaxies).}
\label{fig:dr3dp2-vs-eboss}
\end{figure}

To build a sample with the correct n(z) we intentionally over-fit a Gaussian Mixture Model to the n(z) from eBOSS spectra. The NGC imaging data are incomplete, so we drop NGC spectra and weight by the spectroscopic completeness (1/TSR in the \verb|eBOSS.ELG.obiwan.eboss*.fits| tables). Fig. \ref{fig:nz} shows the resulting n(z) and that a 10 component GMM reproduces it well. 

\begin{figure}
     \subfloat[eBOSS SGC\label{fig:nz-eboss}]{%
       \includegraphics[width=0.49\columnwidth]{nz_eboss}
     }
     \hfill
     \subfloat[10 component GMM\label{fig:nz-eboss-fit}]{%
       \includegraphics[width=0.46\columnwidth]{nz_eboss_and_thefit}
     }
\caption{(Left) n(z) for eBOSS SGC based on eBOSS 21, 22, and 23 spectra. (Right) Overplotting the PDF from 10,000 draws from our 10 component GMM for n(z), which intentionally over-fits the data.}
\label{fig:nz}
\end{figure}

We now generate a sample of properties for N ELGs that are representative of real ELGs in eBOSS and that \obiwan\, can inject into the DECaLS images. We draw N samples from our n(z) GMM, drop those outside the allowed redshift range [0,2], redraw the number dropped, and repeat until there are N samples. Each sample gets a unique id, which is an integer [1,N] that we call ``id". For each of the N redshifts, we find the nearest redshift in the combined EXP and DEV DR3-DEEP2 sample. This is a n(z)-weighted draw from ELG-like galaxies within 0.2 mag of the eBOSS ELG SGC target selection boundaries. (A) If the DR3-DEEP2 data point is an ELG under the eBOSS ELG SGC target selection, we ignore the DR3-DEEP2 data point and find the nearest redshift in the EXP eBOSS sample (90\% of the time) or the DEV eBOSS sample (10\% of the time). (B) If the DR3-DEEP2 data point is not an eBOSS ELG SGC target, we ignore the DR3-DEEP2 data point and find the nearest redshift in the subset of the EXP DR3-DEEP2 sample that only included non-eBOSS ELG SGC target selected galaxies (90\% of the time) or the same subset of the DEV DR3-DEEP2 sample (10\% of the time). We now have a redshift (drawn from the n(z) GMM) and a \gb, \rband, \zb mag, $\rhalf$, and sersic index (either 1 or 4) for each of the N draws. We add a random RA and Dec coordinate, positions angle, minor to major axis ratio to each of the N draws. We assign an id saying where the brightness and shape information came from, which we call \verb|id_sample|. This is the SDSS-ID (\verb|plate-mjd-fiberid|) if from the EXP or DEV eBOSS samples or the \tractor-ID (\verb|brickid-objid|) if from the  EXP or DEV DR3-DEEP2 samples. Fig. \ref{fig:final-eboss-sample-10k} shows the PDFs of \gb, \rband, \zb, redshift, and $\rhalf$ for 10,000 draws using the above algorithm.

\begin{figure}
 \includegraphics[width=\columnwidth]{final_eboss_elg_sample_10k_draws}
 \caption{PDFs of \gb, \rband, \zb, redshift, and $\rhalf$ for 10,000 draws using the algorithm in Section \ref{sec:final-eboss-sample}. \obiwan\, will inject galaxies having these properties into the set of DECam CCDs used to produce DR3-era \tractor\, catalogues and the eBOSS ELG target lists.}
 \label{fig:final-eboss-sample-10k}
\end{figure}

\section{Biases and Systematics in \legacypipe}
\label{a:biases-systematics}

This section presents biases and systematics in \legacypipe\, that are not essential to eBOSS science but very important for properly analyzing our \obiwan\, data set.

\begin{figure}
     \subfloat[Distribution including bad sources and systematic offset\label{fig:fracin-present}]{
       \includegraphics[width=0.45\columnwidth]{num_std_dev_gaussfit_flux_bytype_all_notsubmean}
     }
     \hfill
     \subfloat[Bad sources are linearly separable: {\tt{fracin}} $< 0.2$\label{fig:fracin-2dhist}]{
       \includegraphics[width=0.45\columnwidth]{fracin_vs_numstddev_2dhist}
     }
     \hfill
     \subfloat[Bad sources only\label{fig:fracin-dflux}]{
       \includegraphics[width=0.45\columnwidth]{num_std_dev_gaussfit_flux_bytype_all_keepwhatputin_fracin_keep_bad_020_notsubmean}
     }
     \hfill
     \subfloat[Distribution after removing bad sources and subtracting the mean\label{fig:fracin-removed}]{
       \includegraphics[width=0.45\columnwidth]{num_std_dev_gaussfit_flux_bytype_all_keepwhatputin_fracin_020}
     }
\caption{The input distribution of \tractor\,, truth residuals (top left) and the bad sources and systematic offsets we remove to arrive at the true distribution of \tractor\,, truth residuals (bottom right). (Top Left) Number of standard deviations including bad sources at x = 0, and systematic offset to x < 0. (Top Right) The excess of sources with flux residual of zero are bad sources. We find that these have {\tt{fracin}} $< 0.2$ in the \tractor\, catalogues and are linearly separable from all other sources. (Bottom Left) Number of standard deviations for bad sources ({\tt{fracin}} $< 0.2$) (Bottom Right) Number of standard deviations after removing bad sources and subtracting the mean.}
\label{fig:dflux-systematic}
\end{figure}

\begin{figure}
 \includegraphics[width=0.8\columnwidth]{hist_all_quantities_fracin_cut}
 \caption{(Bottom right) Fraction of injected exponential and \dev\, galaxies that are recovered by \legacypipe\, (orange) or remain after \legacypipe\, recovery and the cut on fracin $< 0.2$. The fracin cut removes 11\% of the recovered exponential and 11\% of the recovered \dev\, galaxies. These are similar fractions so the fracin cut should not introduce any systematics.}
 \label{fig:}
\end{figure}

Fig. \ref{fig:confusion} shows that \legacypipe\, is biased towards EXP sources. We find that this is not a consequence of source size. Fig. \ref{fig:rhalf-input} shows the input distribution for $\rhalf$ (top) and how the distribution changes for sources classified as PSF, SIMP, EXP, and DEV. The true $\rhalf$ for type EXP and DEV are very similar. The size of the source does affect its chance of recovery by \legacypipe.

\begin{figure}
 \includegraphics[width=0.7\columnwidth]{hist_true_rhalf_by_type}
 \caption{PDFs of true $\rhalf$ for sources that \legacypipe\, classifies as PSF, SIMP (top) and EXP, DEV (bottom). The most common injected source size is $\rhalf \sim 0.5$\arcsec (Fig. \ref{fig:input}), and this is also the most common recovered source size independent of \tractor\, type (not just SIMP). PSF and SIMP sources are generally smaller than EXP and DEV. However, type DEV sources have a higher fraction of small ($rhalf < 0.5$\arcsec) sources than SIMP or EXP. The true $\rhalf$ distributions for type DEV and EXP are otherwise very similar, which means that the larger \tractor\, errors on $\rhalf$ for type DEV (see Fig. \ref{fig:tractor-uncertainty}) are not due to source size. SIMP sources have the highest fraction of $\rhalf \sim 0.5$\arcsec sources sizes, which probably explains why \tractor\, errors on $\rhalf$ and e1, e2 can be so small. }
 \label{fig:rhalf-input}
\end{figure}

\begin{figure}
 \includegraphics[width=\columnwidth]{grz_hist_by_type}
 \caption{PDFs of true \gb, \rband, \zb magnitude for type EXP, DEV, PSF, and SIMP sources (blue, green, cyan, and magenta, respectively). (Left) EXP and DEV sources with SIMP for comparison. EXP and DEV have nearly identical PDFs, in all bands. The PDFs for EXP and DEV drop to zero for faint sources, and this drop coincides with an increase in the SIMP PDF for faint sources. (Right) PSF and SIMP with EXP for comparison. In \rband\, and \zb, the EXP, SIMP, and PDFs have similar shape but PSF is located about 0.25 mag fainter than SIMP and SIMP is located about 0.25 mag fainter than EXP.}
 \label{fig:grz-hist-type}
\end{figure}

\section{Simulating DESI ELG Galaxies}

We inject simulated galaxies into X deg$^2$ of DR5 imaging at density of X galaxies / deg$^2$. About X\% of the simulated galaxies are DESI ELGs, so this is X times larger than DESI target density. 

\subsection{Simulated Galaxy Sample}

We match DR3 to DEEP2 cutting to only spectroscopically confirmed galaxies. 

\dev comprise less than 3\% of the DESI sample, and do not model them because the sample size is too small to capture the underlying distributions in redshift and brightness. For DESI, we apply the following cuts,

{\it{ALL}}
\begin{itemize}
\item flux $>$ 0, ivar $>$ 0
\item rename ``EXP, REX, and SIMP'' as EXP
\item rename ``PSF" as EXP but with rhalf= avg(psfsize g,r,z) / 2
\item rhalf $<$ 5
\end{itemize}

{\it{DESI + EXP (DEV, COMP dropped)}}
\begin{itemize}
\item redshift >= 0.8-0.2 and redshift <= 1.4 + 0.2, so we dont fit a gaussian to a step function
\item 0.5 mag padding perpendicular to the TS box
\item 0.5 mag deeper than than g,r,z depth limits
\item fit GMM to [fwhm-OR-rhalf, g-r, r-z,z,redshift], 8 components doesn't overfit but captures correlations between variables
\item draw N points, drop points with LogicalOr (0.8 < redshift > 1.4, more than 0.5 deeper than g, r, z limits, and rhalf > pixscale/2), redraw as many points as dropped, repeat until have N points
\end{itemize}

\subsection{Brightness and shape with the appropriate n(z)}

We model the DESI n(z) for ELGs by over-fitting a GMM model to the desired n(z) for DESI. We randomly sampled 100,000 points from the Sanchez \& Kirkby ELG mocks, then fit a 12 component GMM to the resulting n(z) since this reproduced the n(z) very well.

The procedure for generating the sample of ELGs with representative properties for DESI is as follows. We have GMM models for n(z) and the joint distribution of redshift, brightness, and shape. Draw N samples from the n(z) model. Draw 10k samples from the redshift, brigthness, shape model, filtering out points outside the redshift or detection limits. Organize the 10k samples in a KD Tree. For each of the N samples, find the nearest redshift in the 10k sample, and assign the corresponding brightness and shape. This becomes the sample we inject into the imaging data. It has the exact n(z) for DESI or eBOSS and reasonable brightnesses and shapes for each redshift. 42\% of the DESI sample is in the DESI TS box. Note, we repeated the above procedure using DR2 and DR3, respectively, instead of DR5 and ended up with similar Gaussian Mixture Models.

\section{Data Products}
\label{sec:data-products}

TRANSFER DATA TO eBOSS PROJECT DISK SPACE SAY HOW PEOPLE CAN ACCESS IT

\section{Target Selection and Tractor Catalogue Cuts for ELGs}

We use the following target selection and Tractor catalogue cuts to construct our ELG samples for DESI and eBOSS. The ``baseline'' ELG target selection for DESI is  

For eBOSS SGC it is

The color-color box for NGC target selection is a subset of the above, so we simply use the SGC selection in this paper. For both the DESI and eBOSS sample, we apply the following ``quality assurance'' cuts:

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


% Don't change these lines
\bsp	% typesetting comment
\label{lastpage}
\end{document}

% End of mnras_template.tex
